<?php
/**
 * interface/modules/zend_modules/module/Installer/view/installer/installer/configure.phtml
 *
 * @package   OpenEMR
 * @link      https://www.open-emr.org
 * @author    Jacob T.Paul <jacob@zhservices.com>
 * @author    Vipin Kumar <vipink@zhservices.com>
 * @author    Remesh Babu S <remesh@zhservices.com>
 * @copyright Copyright (c) 2013 Z&H Consultancy Services Private Limited <sam@zhservices.com>
 * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3
 */

// Warning : PoC code
// TBD - Must handle modules in external namespaces
Use OpenEMR\Modules;

$listener = $this->listenerObject;
$hangers = $this->hangers;
$Hooks = $this->Hooks;
$hookObj = $this->hookObject;
$mod_id = $this->mod_id;
$title = $listener->z_xlt('Module Installer');
$this->headTitle($title);
$baseModuleDir = $GLOBALS['baseModDir'];
$customDir = $GLOBALS['customModDir'];
$zendModDir = $GLOBALS['zendModDir'];
$confirmationMSG = $listener->z_xlt("Do you really want to delete?");
// TODO: Change all of these magic numbers into constants, set them in the view and use them here so we can know what this all means.
if (count($TabSettings) > 0) {

    ?>
    <div class="easyui-tabs h-auto" id="tab<?php echo $this->escapeHtml($mod_id); ?>">
        <?php
        if (isset($TabSettings[1]) && $TabSettings[1] > 0) {
            ?>
            <div title="<?php echo $listener->z_xla('Access Control'); ?>" id="tab_acl<?php echo $this->escapeHtml($mod_id); ?>" iconCls="icon-acl">
                <div class="easyui-accordion h-auto" id="configaccord<?php echo $this->escapeHtml($mod_id); ?>" style="width: 58.125rem; margin: 0.3125rem;">
                    <iframe src="<?php echo $GLOBALS['webroot']; ?>/interface/modules/zend_modules/public/acl/acltab?module_id=<?php echo $this->escapeHtml($this->mod_id); ?>" class="w-100" style="height: 43.75rem; overflow: hidden;" frameborder="0"></iframe>
                </div>
            </div>
            <?php
        } else {
            ?>
            <div class="easyui-accordion" id="configaccord<?php echo $this->escapeHtml($mod_id); ?>" class="h-auto" style="width: 58.125rem; margin: 0.3125rem;"></div>
            <?php
        }
        if (isset($TabSettings[2]) && $TabSettings[2] > 0) {
            ?>
            <div title="<?php echo $listener->z_xla('Preference'); ?>" id="tab_preference<?php echo $this->escapeHtml($mod_id); ?>" iconCls="icon-preference">
                <!-- For Future Development-->
            </div>
            <?php
        }
        if (isset($TabSettings[3]) && $TabSettings[3] > 0) {
            $modID = '';
            ?>
            <div title="<?php echo $listener->z_xla('Hooks'); ?>" id="tab_hooks<?php echo $this->escapeHtml($mod_id); ?>" iconCls="icon-plug">
            <div class="table-responsive">
                <table class="table">
                    <tr>
                        <td colspan="2" class="font-weight-bold text-center" style="font-size: 0.875rem;">
                            <?php echo $listener->z_xlt("Manage Hooks"); ?>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <form name="hooksform<?php echo $this->escapeHtml($mod_id); ?>" id="hooksform<?php echo $this->escapeHtml($mod_id); ?>">
                              <div class="table-responsive">
                                <table class="table">
                                    <tr>
                                        <td style="width: 9.375rem"><span id="hook_response<?php echo $this->escapeHtml($mod_id); ?>">&nbsp;</span></td>
                                        <?php
                                        $hanger_count = 0;
                                        foreach ($hangers as $value => $title) {
                                            ?>
                                            <td class="text-center"><?php echo $listener->z_xlt($title); ?></td>
                                            <?php
                                            $hanger_count++;
                                        }
                                        ?>
                                    </tr>
                                    <?php
                                    if (count($Hooks) > 0) {
                                        foreach ($Hooks as $obj_hooks) {
                                            ?>
                                            <tr>
                                                <td><?php echo $listener->z_xlt($obj_hooks['title']); ?></td>
                                                <?php
                                                foreach ($hangers as $value => $title) {
                                                    $checked = "";
                                                    if ($hookObj->getHookStatus($mod_id, $obj_hooks['name'], $value) == "1") {
                                                        $checked = "checked=\"checked\"";
                                                    }
                                                    ?>
                                                    <td class="text-center">
                                                        <input type="checkbox" <?php echo $checked; ?>
                                                            name="hook_hanger[<?php echo $this->escapeHtml($obj_hooks['name']); ?>][<?php echo $this->escapeHtml($value); ?>]"
                                                            id="hook_hanger_<?php echo $this->escapeHtml($obj_hooks['name']); ?>_<?php echo $this->escapeHtml($value); ?>"
                                                            value="<?php echo $this->escapeHtml($obj_hooks['name']) . "," . $this->escapeHtml($value); ?>"
                                                            onclick="javascript:SaveMe('hooksform',<?php echo $this->escapeHtml($mod_id); ?>)" />
                                                    </td>
                                                    <?php
                                                }
                                                ?>
                                            </tr>
                                            <?php
                                        }
                                    } else { ?>
                                        <tr>
                                            <td colspan="<?php echo $this->escapeHtml($hanger_count) + 1; ?>" class="text-center" style="font-size: 0.875rem">
                                                <?php echo $listener->z_xlt('No Hooks Available in this Module'); ?>
                                            </td>
                                        </tr>
                                        <?php
                                    }
                                    ?>
                                </table>
                              </div>
                                <input type="hidden" name="mod_id" value="<?php echo $this->escapeHtml($mod_id); ?>" />
                            </form>
                        </td>
                    </tr>
                </table>
              </div>
            </div>
            <!-- Start Configuration Tab -->
            <div title="<?php echo $listener->z_xla('Settings'); ?>" id="tab_config<?php echo $this->escapeHtml($mod_id); ?>" iconCls="icon-preference">
                <?php
                if (is_object($this->settings) && count($this->settings) > 0) {

                    $form = $this->settings;
                    if (method_exists($form, 'prepare')) {
                        $form->prepare();
                        ?>
                        <form name="configform" id="configform<?php echo $this->escapeHtml($mod_id); ?>">
                          <div class="table-responsive">
                            <table class="table m-0" style="height: 8.75rem">
                                <?php

                                $i = 0;
                                foreach ($form as $element) {
                                    ?>
                                    <tr>
                                        <td><?php echo $listener->z_xlt($element->getLabel()); ?></td>
                                        <td><?php echo $this->formElement($element->setValue($configuration[$element->getAttribute('id')]['field_value'])); ?></td>
                                    </tr>
                                    <?php
                                    $i++;
                                }
                                ?>
                                <tr>
                                    <td></td>
                                    <td>
                                        <a href="#" class="easyui-linkbutton" iconCls="icon-save" plain="true" onclick="javascript:saveConfig('configform',<?php echo $this->escapeHtml($mod_id); ?>)">
                                            <?php echo $listener->z_xlt('Save'); ?>
                                        </a>
                                        <span id='target<?php echo $this->escapeHtml($mod_id); ?>' style="color: #996600"></span>
                                    </td>
                                </tr>
                            </table>
                          </div>
                            <input type="hidden" name="module_id" value="<?php echo $this->escapeHtml($mod_id); ?>" />
                        </form>
                        <?php
                    } else {
                        echo $listener->z_xlt('No Settings avaliable in this module');
                    }
                } else {
                    echo $listener->z_xlt('No Settings avaliable in this module');
                }
                ?>
            </div>
            <!-- End Configuration Tab -->
            <?php
        }
        ?>
        <?php if (count($setup) > 0) { ?>
            <div class="h-auto" title="<?php echo $listener->z_xla($setup['title']); ?>" style="width: 50rem;" id="tab_config<?php echo $this->escapeHtml($mod_id); ?>" iconCls="icon-setup">
                <iframe class="w-100" scrolling="yes" frameborder="0" src="<?php echo $this->basePath() . '/' . $this->escapeHtml($setup['module_dir']); ?>/setup/index" style="height: 25rem;">
                </iframe>
            </div>
        <?php } ?>
    </div>
    <?php
} elseif (count($setup) > 0) { ?>
    <div class="easyui-tabs h-auto" id="tab<?php echo $this->escapeHtml($mod_id); ?>">
        <div title="<?php echo $listener->z_xla($setup['title']); ?>"
            id="tab_config<?php echo $this->escapeHtml($mod_id); ?>"
            iconCls="icon-setup">
            <iframe class="w-100" scrolling="yes" frameborder="0" src="<?php echo $this->basePath() . '/' . $this->escapeHtml($setup['module_dir']); ?>/setup/index" style="height: 25rem;">
            </iframe>
        </div>
    </div>
    <?php
} else {
    // Final check for config
    // TBD : clsOeModule
    $rs_mod = sqlQuery('select * from modules where mod_id=? and mod_active=1', [$mod_id]);
    $fConfig = dirname(realpath('.')) . '/custom_modules/' . $rs_mod['mod_directory'] . '/moduleConfig.php';
    if (($rs_mod['type'] == 0) && file_exists($fConfig)) {
        ?>
        <div class="easyui-tabs h-auto" id="tab<?php echo $this->escapeHtml($mod_id); ?>">
            <iframe class="w-100" scrolling="yes" frameborder="0" src="<?php echo dirname($this->basePath(), 2) . '/custom_modules/' . $rs_mod['mod_directory'] . '/moduleConfig.php'; ?>" style="height: 25rem;">
            </iframe>
        </div>
        <?php
    } else {
        ?>
        <div class="easyui-tabs h-auto" id="tab<?php echo $this->escapeHtml($mod_id); ?>">
            <?php echo $listener->z_xlt('No Configuration Defined for this Module'); ?>
        </div>
        <?php
    }
}
?>
