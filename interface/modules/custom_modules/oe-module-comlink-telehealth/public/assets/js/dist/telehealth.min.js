/*! For license information please see telehealth.min.js.LICENSE.txt */
!function(){"use strict";function e(e){var t=this,i=0;return this.checkRegistration=function(){if(i++>10)return void console.error("Failed to get a valid telehealth registration for user");let n=e+"?action=check_registration";window.top.restoreSession(),window.fetch(n).then((e=>{if(!e.ok)throw new Error("Registration check failed");return e.json()})).then((e=>{e&&e.hasOwnProperty("errorCode")&&402==e.errorCode&&(t.settings={}),t.settings=e})).catch((e=>{console.error("Failed to execute check_registration action",e),setTimeout(t.checkRegistration.bind(t),2e3)}))},this}function t(e,t,i,n){let o=this,s=null,a=null;this.cancelDialog=function(){let e=a.querySelectorAll(".hangup-section"),t=a.querySelector(".hangup-section.hangup-section-start");if(e&&e.length)for(let t=0;t<e.length;t++)e[t].classList.add("d-none");t&&t.classList.remove("d-none"),s.hide()},this.processConfirmYesAction=function(e){a.querySelector(".row-confirm").classList.add("d-none"),a.querySelector(".row-update-status").classList.remove("d-none")},this.sendAppointmentStatusUpdate=function(n){console.log("Setting appointment to status ",n);let o="action=set_appointment_status&pc_eid="+encodeURIComponent(t)+"&status="+encodeURIComponent(n);window.top.restoreSession(),window.fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o,redirect:"manual"}).then((i=>{i.ok&&200==i.status||(alert(e.APPOINTMENT_STATUS_UPDATE_FAILED),console.error("Failed to update appointment "+t+" to status "+n))}))},this.updateAppointmentStatusAndClose=function(e){jQuery(a).on("hidden.bs.modal",(function(){try{jQuery(a).off("hidden.bs.modal"),n()}catch(e){console.error(e)}try{"CloseWithoutUpdating"!=e&&o.sendAppointmentStatusUpdate(e)}catch(e){console.error(e)}})),s.hide()},this.processHangupSetting=function(e){let t=e.currentTarget.dataset.status||"CloseWithoutUpdating";o.updateAppointmentStatusAndClose(t)},this.processSetStatusFromSelector=function(e){let t=a.querySelector(".appointment-status-update");t&&t.value?o.updateAppointmentStatusAndClose(t.value):console.error("Failed to find selector .appointment-status-update node or value is not defined for node")},this.show=function(){a=document.getElementById("telehealth-container-hangup-confirm"),s=new bootstrap.Modal(a,{keyboard:!1,focus:!0,backdrop:"static"});let e=a.querySelectorAll(".btn-telehealth-confirm-cancel");for(var t=0;t<e.length;t++)e[t].addEventListener("click",o.cancelDialog);let i=a.querySelector(".btn-telehealth-confirm-yes");i?i.addEventListener("click",o.processConfirmYesAction):console.error("Could not find selector with .btn-telehealth-confirm-yes");let n=a.querySelector(".btn-telehealth-session-select-update");for(n&&n.addEventListener("click",o.processSetStatusFromSelector),e=a.querySelectorAll(".btn-telehealth-session-close"),t=0;t<e.length;t++)e[t].addEventListener("click",o.processHangupSetting);s.show()}}function i(e,t,i){let n=this;return n.node=e,n.value=t,n.callback=i,n.enabled=!0===t,n.init=function(){n.enabled?n.attach():n.detatch()},n.attach=function(){this.node&&(this.node.addEventListener("click",this.callback),this.node.classList.remove("d-none"))},n.detatch=function(){this.node&&(this.node.removeEventListener("click",this.callback),this.node.classList.add("d-none"))},n.destruct=function(){n.detatch(),n.node=null,n.callback=null},n.toggle=function(){n.enabled=!n.enabled,n.enabled?this.attach():this.detatch()},n.init(),n}function n(e,t){var n=this;function o(){}function s(e,t,i){e.hasOwnProperty(t)||(e[t]=i)}return n.__buttons={},n.__container=e,n.init=function(){if(s(t=t||{},"notes",!1),s(t,"notesCallback",o),s(t,"microphone",!0),s(t,"microphoneCallback",o),s(t,"video",!0),s(t,"videoCallback",o),s(t,"expand",!1),s(t,"expandCallback",o),s(t,"hangup",!1),s(t,"hangupCallback",o),s(t,"screenshare",!0),s(t,"screenshareCallback",o),s(t,"invite",!1),s(t,"inviteCallback",o),["notes","microphone","video","expand","hangup","screenshare","invite"].forEach((e=>{let s=n.__container.querySelector(".telehealth-btn-"+e),a=t[e+"Callback"]||o;s?n.__buttons[e]=new i(s,t[e],a):console.error("Failed to find node for telehealth-btn-"+e)})),!n.__buttons.microphone.enabled){let e=n.__buttons.microphone,t=e.node.querySelector(".fa");e&&t?(e.toggle(),t.classList.add("fa-microphone-slash"),t.classList.remove("fa-microphone")):console.error("Failed to find microphone node and fa icon")}if(!n.__buttons.video.enabled){let e=n.__buttons.video,t=e.node.querySelector(".fa");e&&t?(e.toggle(),t.classList.add("fa-video-slash"),t.classList.remove("fa-video")):console.error("Failed to find video node and fa icon")}},n.destruct=function(){Object.values(n.__buttons).forEach((e=>e.detatch())),n.__container=null},n.toggleButtons=function(e){e.forEach((e=>{n.__buttons[e]?n.__buttons[e].toggle():console.error("Failed to find button to toggle for button "+e)}))},n.init(),n}class o{__call=null;__container=null;__video=null;constructor(e){if(this.__call=null,this.__container=document.getElementById(e),this.__video=this.__container.querySelector(".remote-video"),!this.__video)throw new Error("Failed to find #"+e+" element")}hasVideo(){return!this.isAvailable()}getVideoStream(){return this.__video.srcObject}isAvailable(){return null==this.__call}getRemotePartyId(){return this.__call?this.__call.getRemotePartyId():null}attach(e,t,i){if(this.__call=e,null==e||null==t)throw console.error("Call or stream were null.  Cannot proceed",{call:e,stream:t}),new Error("call and stream cannot be null");this.__video.srcObject=t,this.__video.play();let n=this.__container.querySelector(".participant-label");n&&(n.textContent=i),this.__video.title=i}detach(){this.__call&&this.__call.setUserData(null),this.__call=null,this.__video.srcObject=null}hide(){this.__container&&this.__container.classList.add("d-none")}show(){this.__container&&this.__container.classList.remove("d-none")}setPinnedStatus(e){this.__container&&(e?this.__container.classList.add("pinned"):this.__container.classList.remove("pinned"))}}class s{__videoNode=null;__screenshareNode=null;__videoSlot=null;__screenshareSlot=null;__currentSlot=null;__containerId=null;__boundInternalEvent=null;__participant=null;__isPinned=!1;__selectCallbacks=[];constructor(e,t){let i=document.getElementById(e),n="participant-list-template-node",s=i.querySelector("."+n);if(!i)throw new Error("Failed to find container id with "+e);if(!s)throw new Error("Failed to find template container with ."+n);let a="participant-video-"+t,r="participant-screenshare-"+t;this.__boundInternalEvent=this.handleSelectEvent.bind(this),this.__videoNode=this.__setupParticipantContainer(e,a,this.__boundInternalEvent),this.__screenshareNode=this.__setupParticipantContainer(e,r,this.__boundInternalEvent),this.__videoSlot=new o(a),this.__screenshareSlot=new o(r),this.__currentSlot=this.__videoSlot,this.__selectCallbacks=[],this.__isPinned=!1}__setupParticipantContainer(e,t,i){let n=document.getElementById(e),o="participant-list-template-node",s=n.querySelector("."+o);if(!n)throw new Error("Failed to find container id with "+e);if(!s)throw new Error("Failed to find template container with ."+o);let a=s.cloneNode(!0);return a.classList.remove(o),a.id=t,n.appendChild(a),a.addEventListener("click",i),a}setPinnedStatus(e){this.__isPinned=e,this.__videoSlot&&this.__videoSlot.setPinnedStatus(e),this.__screenshareSlot&&this.__screenshareSlot.setPinnedStatus(e)}isPinned(){return this.__isPinned}handleSelectEvent(e){this.__selectCallbacks.forEach((e=>e(this)))}addCallerSelectListener(e){this.__selectCallbacks.push(e)}getRemotePartyId(){return this.__currentSlot?this.__currentSlot.getRemotePartyId():null}hide(){this.__currentSlot&&this.__currentSlot.hide()}show(){this.__currentSlot&&this.__currentSlot.show()}isAvailable(){return this.__videoSlot.isAvailable()}isAvailableForCall(e){return!(!this.__videoSlot.isAvailable()&&this.__videoSlot.getRemotePartyId()!=e.getRemotePartyId())}getCurrentCallStream(){return this.__currentSlot?this.__currentSlot.getVideoStream():null}getParticipant(){return this.__participant}attach(e,t,i){if(null==e||null==t||null==i)throw console.error("Call, stream, or participant were null.  Cannot proceed",{call:e,stream:t,participant:i}),new Error("call, stream, and participant cannot be null");e.isScreenSharing()?(this.__screenshareSlot.isAvailable()||this.__screenshareSlot.detach(),this.__screenshareSlot.attach(e,t,i.callerName||""),this.showScreenshare()):(this.__videoSlot.isAvailable()||this.__videoSlot.detach(),this.__videoSlot.attach(e,t,i.callerName||""),this.showVideo()),this.__participant=i,e.setUserData(this)}showScreenshare(){this.__videoSlot.hide(),this.__screenshareSlot.show(),this.__currentSlot=this.__screenshareSlot}showVideo(){this.__videoSlot.show(),this.__screenshareSlot.hide(),this.__currentSlot=this.__videoSlot}detachScreenshare(){this.__screenshareSlot.detach(),this.__videoSlot&&this.showVideo()}detatchVideo(){this.__videoSlot.detach(),this.__currentSlot=null,this.__participant=null}detach(){this.detachScreenshare(),this.detatchVideo()}destruct(){this.detach(),this.__selectCallbacks=[],this.__screenshareNode&&(this.__screenshareNode.removeEventListener("click",this.__boundInternalEvent),this.__screenshareNode.parentNode.removeChild(this.__screenshareNode),this.__screenshareNode=null),this.__videoNode&&(this.__videoNode.removeEventListener("click",this.__boundInternalEvent),this.__videoNode.parentNode.removeChild(this.__videoNode),this.__videoNode=null)}}function a(e,t){if(!e)throw new Error(t)}class r{static invokeAndIgnoreExceptions(e){try{e()}catch(e){console.log("Ignoring exception in user callback: "+e)}}}class l{constructor(e){this.t=e,this.i="",this.h=new TextDecoder("utf-8"),this.o=!1}cancel(){this.t.cancel()}eof(){return this.o}l(){const e=this.i.indexOf("\r\n");if(-1==e)return null;const t=this.i.substr(0,e);return this.i=this.i.substr(e+2),t}u(){return this.t.read().then((e=>{if(e.done)return this.o=!0,Promise.resolve(this.i);this.i+=this.h.decode(e.value);const t=this.l();return t?Promise.resolve(t):this.u()}))}readEvent(){if(this.o)return Promise.reject();const e=this.l();return e?Promise.resolve(e):this.u()}}class c{constructor(e){this._=e}v(e,t){return fetch(this._+e,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((e=>e.ok?e.json():Promise.reject(e.status)))}p(e,t){return fetch(this._+e,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}createBridge(e,t,i){const n={userId:e,passwordHash:t,type:i};return fetch(this._+"/client/createBridge",{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}invite(e){return this.p("/client/invite",{callId:e})}call(e,t,i){return this.v("/client/call",{callerId:e,calleeId:t,isScreenSharing:i})}accept(e,t){return this.p("/client/accept",{callId:e,token:t})}reject(e,t){return this.p("/client/reject",{callId:e,token:t})}offer(e,t,i){return this.p("/client/offer",{callId:e,sdp:i,token:t})}answer(e,t,i){return this.p("/client/answer",{callId:e,sdp:i,token:t})}ice(e,t,i){return this.p("/client/ice",{callId:e,candidate:t,token:i})}end(e,t){return this.p("/client/end",{callId:e,token:t})}}const h=new class{constructor(){this.g=[],this.I=0,this.m=-1}C(){this.g.forEach((e=>e.func()))}S(){this.m=setInterval((()=>this.C()),1e3)}k(){clearInterval(this.m),this.m=-1}addTask(e){const t=this.I++,i={id:t,func:e};return this.g.push(i),1==this.g.length&&this.S(),t}removeTask(e){const t=this.g.findIndex((t=>t.id==e));-1!=t&&(this.g.splice(t,1),0==this.g.length&&this.k())}},d=new class{newAudioContext(){return new(window.AudioContext||window.webkitAudioContext)}};class u{constructor(){this.P=-1,this.V=d.newAudioContext(),this.T=this.V.createAnalyser(),this.T.fftSize=2048,this.L=new Uint8Array(this.T.frequencyBinCount),this.A=null,this.db=0,this.ondbthresholdexceeded=e=>{},this.dbthreshold=65}connect(e){-1==this.P&&(this.P=h.addTask((()=>this.j()))),this.A&&this.A.disconnect(),this.A=this.V.createMediaStreamSource(e),this.A.connect(this.T)}disconnect(){-1!=this.P&&(h.removeTask(this.P),this.A.disconnect(),this.A=null,this.P=-1)}j(){const e=this.L.length;let t=0;this.T.getByteTimeDomainData(this.L);for(let i=0;i<e;i++){const e=.0078125*(this.L[i]-128);t+=e*e}this.db=10*Math.log10(t/e),console.log("db="+this.db),this.db>=this.dbthreshold&&r.invokeAndIgnoreExceptions((()=>this.ondbthresholdexceeded(this)))}}const _="Copyright (c) 2023 Comlink Inc.";class p{constructor(e){this.B=e.isInbound,this.O=e.isScreenSharing,this.R=e.remotePartyId,this.U=e.bridge,this.M=e.callId,this.N=e.config,this.D=e.token,this.J=null,this.H=null,this.K=null,this.t=null,this.F=null,this.G=null,this.W=[],e.isInbound?this.q=1:this.q=0,this.oncallstarted=e=>this.X("Unhandled event: call started: "+e.M),this.oncallrejected=e=>this.X("Unhandled event: call rejected: "+e.M),this.oncallended=e=>this.X("Unhandled event: call ended: "+e.M),this.onstreamupdated=(e,t)=>this.X("Unhandled event: stream updated: "+e.M),this.onparticipantlistupdated=(e,t)=>this.X("Unhandled event: participant list updated: "+e.M),this.onviewportlayoutupdated=(e,t)=>this.X("Unahndled event: viewport layout updated: "+t),this.onfacialrecognizerresults=(e,t)=>this.X("Unhandled event: facial recognizer results: "+t)}Y(e){console.log("VC/"+this.M+": "+e)}Z(e){console.error("VC/"+this.M+": "+e)}X(e){console.warn("VC/"+this.M+": "+e)}$(){return this.J=new RTCPeerConnection(this.N),this.J.onicecandidate=e=>this.tt(e),this.J.ontrack=e=>this.it(e),this.J.onremovetrack=e=>this.st(e),this.O?this.B?Promise.resolve(this):this.et():this.ht()}ht(){return this.U.getLocalMediaStream().then((e=>{e.getTracks().forEach((t=>this.J.addTrack(t,e))),e.oninactive=()=>this.nt()}))}et(){return navigator.mediaDevices.getDisplayMedia({video:{cursor:"always"},audio:!0}).then((e=>{e.getTracks().forEach((t=>this.J.addTrack(t,e))),e.oninactive=()=>this.nt()}))}rt(){6!=this.q&&(this.K&&(this.K.disconnect(),this.K=null),this.q=6,this.U.ot(this),this.J.close())}ct(e){switch(a("CALL"==e.type,'Bad event type. "CALL" expected.'),e.name){case"accept":this.lt();break;case"end":this.dt();break;case"reject":this.ut();break;case"sdp":this._t(e.sdp,e.action);break;case"ice":this.vt(e.iceCandidate);break;case"participants":this.gt(e.userIds);break;case"viewportLayout":this.bt({frameWidth:e.frameWidth,frameHeight:e.frameHeight,viewports:e.viewports});break;case"facialRecognition":this.ft({callId:e.tagCallId,tag:e.tag,confidence:e.confidence});break;default:throw new Error("Bad call state")}}gt(e){this.F=e,r.invokeAndIgnoreExceptions((()=>this.onparticipantlistupdated(this,this.F)))}bt(e){this.G=e,r.invokeAndIgnoreExceptions((()=>this.onviewportlayoutupdated(this,this.G)))}ft(e){r.invokeAndIgnoreExceptions((()=>this.onfacialrecognizerresults(this,e)))}vt(e){this.J.remoteDescription?this.J.addIceCandidate(e):this.W.push(e)}it(e){this.t=e.streams[0],this.K&&this.K.connect(this.t),r.invokeAndIgnoreExceptions((()=>this.onstreamupdated(this,this.t)))}st(e){}nt(){r.invokeAndIgnoreExceptions((()=>this.oncallended(this))),this.stop()}dt(){r.invokeAndIgnoreExceptions((()=>this.oncallended(this))),this.stop()}lt(){this.J.createOffer({offerToReceiveVideo:!0,offerToReceiveAudio:!0}).then((e=>this.J.setLocalDescription(e))).then((()=>this.U.wt.offer(this.M,this.D,this.J.localDescription.sdp))).catch((e=>{throw this.It(e),e})),r.invokeAndIgnoreExceptions((()=>this.oncallstarted(this)))}ut(){this.U.ot(this),this.q=4,r.invokeAndIgnoreExceptions((()=>this.oncallrejected(this)))}_t(e,t){const i=new RTCSessionDescription({type:t,sdp:e});"offer"==t?this.J.setRemoteDescription(i).then((()=>(this.yt(),this.J.createAnswer()))).then((e=>this.J.setLocalDescription(e))).then((()=>this.U.wt.answer(this.M,this.D,this.J.localDescription.sdp))).then((e=>(this.q=3,e))).catch((e=>{throw this.It(e),e})):"answer"==t&&this.J.setRemoteDescription(i).then((()=>{this.yt(),this.q=3})).catch((e=>{throw this.It(e),e}))}yt(){this.W.forEach((e=>{this.J.addIceCandidate(e)})),this.W=[]}tt(e){if(e.candidate)try{this.U.wt.ice(this.M,e.candidate,this.D)}catch(e){this.X("failed to transmit ICE candidate")}}It(e){this.q=4,this.Z("panic: "+e.message)}getParticipantList(){return this.F}getViewportLayout(){return this.G}getCallId(){return this.M}getVideoBridge(){return this.U}getRemotePartyId(){return this.R}isInbound(){return this.B}setUserData(e){this.H=e}getUserData(){return this.H}isScreenSharing(){return this.O}attachActivityMonitor(e,t){a(null==this.K,"Activity notifier already attached"),a(null!=t,"Activity monitor callback not defined"),this.K=new u,this.K.dbthreshold=e,this.K.ondbthresholdexceeded=e=>r.invokeAndIgnoreExceptions((()=>t(this))),this.t&&this.K.connect(this.t)}getSoundLevel(){return this.K||this.K.db}start(){return a(0==this.q,"Call already initialized"),this.q=1,this.Y("starting"),this.U.wt.call(this.U.getUserId(),this.R,this.O).then((e=>(this.M=e.callId,this.N=e.config,this.D=e.token,this.$()))).then((()=>this.U.wt.invite(this.M))).then((()=>(this.q=2,this.U.Ct(this),this))).catch((e=>{throw this.It(e),e}))}accept(){return a(1==this.q,"Invalid call state"),a(this.B,"Not an inbound call"),this.Y("accepting"),this.$().then((()=>this.U.wt.accept(this.M,this.D))).then((e=>(this.q=2,this))).catch((e=>{throw this.It(e),e}))}reject(){return a(1==this.q,"Invalid call state"),a(this.B,"Not an inbound call"),this.Y("rejecting"),this.U.wt.reject(this.M,this.D).then((e=>(this.q=5,this.U.ot(this),this))).catch((e=>{throw this.It(e),e}))}stop(){return 6!=this.q&&4!=this.q?(this.rt(),this.U.wt.end(this.M,this.D).then((()=>this))):Promise.resolve(this)}muteRemoteAudio(e){a("boolean"==typeof e,"Expected a boolean value"),this.J.getReceivers().forEach((t=>{"audio"==t.track.kind&&(t.track.enabled=e)}))}}class m{constructor(e){this.St=e.userId,this.kt=e.type,this.Et=e.passwordHash,this.wt=new c(e.serviceUrl||""),this.Pt=!1,this.Vt={},this.Tt=!1,this.Lt=!1,this.At=null,this.jt=null,this.onbridgeactive=e=>console.log("onbridgeactive event not handled"),this.onbridgeinactive=e=>console.log("onbridgeinactive event not handled"),this.onbridgefailure=e=>console.log("onbridgefailure event not handled"),this.onincomingcall=e=>{console.log("Inbound call event not handled; call rejected."),e.reject()}}It(e){console.log("Catastrophic bridge failure: "+e),r.invokeAndIgnoreExceptions((()=>this.onbridgefailure(this))),this.shutdown()}Bt(){this.Pt?this.It(new Error("Event stream closed unexpectedly")):(r.invokeAndIgnoreExceptions((()=>this.onbridgeinactive(this))),this.shutdown())}Ot(){this.At.readEvent().then((e=>{if(this.At.eof())this.Bt();else{try{const t=JSON.parse(e);this.ct(t)}catch(e){return void this.It(e)}this.Ot()}}))}Rt(e){const t=this.Vt[e.callId];t?t.ct(e):console.log("Invalid call identifier in the event stream: "+e.callId)}Ut(e){const t=new p({bridge:this,callId:e.callId,isInbound:!0,isScreenSharing:e.isScreenSharing,remotePartyId:e.callerId,config:e.config,token:e.token});this.Ct(t),r.invokeAndIgnoreExceptions((()=>this.onincomingcall(t)))}xt(e){this.Pt||(this.Pt=!0,r.invokeAndIgnoreExceptions((()=>this.onbridgeactive(this))))}ct(e){switch(console.log(e),e.type){case"INCOMING":this.Ut(e);break;case"KEEPALIVE":this.xt(e);break;case"CALL":this.Rt(e);break;default:this.It(new Error("Bad event type: "+e.type+". Corrupt stream?"))}}Mt(){Object.values(this.Vt).forEach((e=>e.rt())),this.Vt={}}Ct(e){this.Vt[e.getCallId()]=e}ot(e){const t=e.getCallId();this.Vt.hasOwnProperty(t)&&delete this.Vt[t]}getUserId(){return this.St}getCalls(){return Object.values(this.Vt)}hasCamera(){return this.Tt}hasMicrophone(){return this.Lt}getCallById(e){return this.Vt[e]}isActive(){return this.Pt}getLocalMediaStream(){return a(this.Pt,"VideoBridge not active"),this.jt?Promise.resolve(this.jt):navigator.mediaDevices.enumerateDevices().then((e=>{var t={};return null!=e.find((e=>"videoinput"==e.kind))&&(this.Tt=!0,t.video={width:800,height:600}),null!=e.find((e=>"audioinput"==e.kind))&&(this.Lt=!0,t.audio={channels:1}),navigator.mediaDevices.getUserMedia(t)})).then((e=>(this.jt=e,e)))}closeLocalMediaStream(){a(this.Pt,"VideoBridge not active"),this.jt&&(this.jt.getTracks().forEach((e=>e.stop())),this.jt=null,this.Lt=!1,this.Tt=!1)}enableCamera(e){a(this.Pt,"Video bridge not active"),a("boolean"==typeof e,"Expected a boolean value"),this.Tt&&this.jt.getTracks().forEach((t=>{"live"==t.readyState&&"video"===t.kind&&(t.enabled=e)}))}enableMicrophone(e){a(this.Pt,"Video bridge not active"),a("boolean"==typeof e,"Expected a boolean value"),this.Lt&&this.jt.getTracks().forEach((t=>{"live"==t.readyState&&"audio"===t.kind&&(t.enabled=e)}))}start(){a(!this.Pt,"Video bridge already active"),console.log("CVB v1.1.2. "+_),this.wt.createBridge(this.St,this.Et,this.kt).then((e=>e.body)).then((e=>{this.At=new l(e.getReader()),this.Ot()})).catch((e=>{console.error("Video bridge creation failure: "+e),r.invokeAndIgnoreExceptions((()=>this.onbridgefailure(this))),this.It(e)}))}shutdown(){a(this.Pt,"Video bridge not active"),console.log("CVB v1.1.2. "+_),Object.values(this.Vt).slice().forEach((e=>e.stop())),this.Vt={},this.At.cancel(),this.closeLocalMediaStream(),this.Pt=!1}createVideoCall(e){return a(this.Pt,"Video bridge not active"),new p({bridge:this,isInbound:!1,isScreenSharing:!1,remotePartyId:e})}createScreenSharingCall(e){return a(this.Pt,"Video bridge not activbe"),new p({bridge:this,isInboud:!1,isScreenSharing:!0,remotePartyId:e})}}class g{isShutdown=!1;userId=null;passwordHash=null;serviceUrl=null;bridge=null;constructor(e,t,i){this.userId=e,this.passwordHash=t,this.serviceUrl=i,this.isRunning=!1}noop(){}startBridge(e){(e=e||{}).onincomingcall=e.onincomingcall||this.noop,e.onbridgeactive=e.onbridgeactive||this.noop,e.onbridgeinactive=e.onbridgeinactive||this.noop,e.onbridgefailure=e.onbridgefailure||this.noop,this.bridge=new m({userId:this.userId,passwordHash:this.passwordHash,type:"normal",serviceUrl:this.serviceUrl}),console.log("Instantiated bridge "+this.userId),this.bridge.onincomingcall=t=>{console.log("Receiving call from "+t.getRemotePartyId()+" for "+this.userId),e.onincomingcall(t)},this.bridge.onbridgeactive=t=>{console.log("The bridge is active "+this.userId),e.onbridgeactive(t)},this.bridge.onbridgeinactive=t=>{console.log("The bridge is inactive "+this.userId),e.onbridgeinactive(t)},this.bridge.onbridgefailure=t=>{if(console.error("The bridge failed "+this.userId),!this.isShutdown)try{e.onbridgefailure(t)}catch(e){console.error("Failure occurred in bridge shutdown handler",e)}this.isShutdown=!0,this.shutdown()},this.bridge.start(),console.log("Started bridge "+this.userId),this.isShutdown=!1}hasLocalPermissionsEnabled(){return!!this.bridge&&this.bridge.hasLocalPermissionsEnabled()}shutdown(){this.isShutdown||(this.bridge.shutdown(),this.isShutdown=!0)}restartMediaStream(){this.isShutdown&&console.error("Bridge is shutdown.  Cannot restart media stream")}getLocalMediaStream(){return this.bridge.getLocalMediaStream()}enableMicrophone(e){return this.bridge.enableMicrophone(e)}enableCamera(e){return this.bridge.enableCamera(e)}createScreenSharingCall(e){return this.bridge.createScreenSharingCall(e)}createVideoCall(e){return this.bridge.createVideoCall(e)}setCallHandlers(e){return this.bridge.setCallHandlers(e)}}class S{videoElement=null;callerSlot=null;constructor(e){if(this.videoElement=document.getElementById(e),!this.videoElement)throw new Error("Failed to find presentation screen dom node with id "+e)}updateCallerSlotScreen(){this.callerSlot&&null!=this.callerSlot.getCurrentCallStream()&&this.videoElement&&this.callerSlot.getCurrentCallStream()!=this.videoElement.srcObject&&(this.videoElement.srcObject=this.callerSlot.getCurrentCallStream(),this.videoElement.play().catch((e=>console.error("presentation-screen failed to play updated call slot",e))))}attach(e){if(null==this.callerSlot||this.callerSlot!==e&&this.callerSlot.getRemotePartyId()!=e.getRemotePartyId()){if(this.callerSlot&&this.detach(),e&&null!=e.getCurrentCallStream()){let t=e.getParticipant()?e.getParticipant().callerName:"";this.videoElement.srcObject=e.getCurrentCallStream(),this.videoElement.play(),this.videoElement.title=t,this.callerSlot=e}}else this.updateCallerSlotScreen()}hide(){this.videoElement&&this.videoElement.classList.add("d-none")}show(){this.videoElement&&this.videoElement.classList.remove("d-none")}getVideoElement(){return this.videoElement}detach(){this.callerSlot=null,this.videoElement.srcObject=null}}class f{modal=null;container=null;pc_eid=null;scriptLocation=null;closeCallback=null;__translations=null;__idx=0;__apiCSRFToken=null;__currentScreen=null;__updatedCallerSettings=null;__currentThirdParty=null;constructor(e,t,i,n,o,s){this.pc_eid=i,this.scriptLocation=n,this.closeCallback=s,this.__translations=t,this.__apiCSRFToken=e,this.__currentThirdParty=o}cancelDialog(){this.closeDialogAndSendCallerSettings()}sendSaveParticipant(e){let t=Object.assign({eid:this.pc_eid},e),i=this.scriptLocation+"?action=save_session_participant";return window.top.restoreSession(),window.fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),redirect:"manual"}).then((e=>{if(e.ok&&200==e.status)return e.json();throw new Error("Failed to save participant in "+this.pc_eid+" with save data")})).then((e=>{let t=e.callerSettings||{};this.showActionAlert("success",this.__translations.PATIENT_INVITATION_SUCCESS),this.__updatedCallerSettings=t,this.__currentThirdParty=t.thirdPartyPatient,this.updateThirdPartyControls(),this.showPrimaryScreen(),setTimeout((()=>{this.closeDialogAndSendCallerSettings()}),1e3)}))}closeDialogAndSendCallerSettings(){jQuery(this.container).on("hidden.bs.modal",(()=>{try{jQuery(this.container).off("hidden.bs.modal"),this.closeCallback(this.__updatedCallerSettings)}catch(e){console.error(e)}try{this.destruct()}catch(e){this.destruct()}})),this.modal.hide()}sendSearchResults(e){let t="/apis/fhir/Patient",i=[];if(e.pid&&i.push("identifier="+e.pid),e.fname||e.lname){let t=[];e.fname&&t.push(e.fname),e.lname&&t.push(e.lname),i.push("name:contains="+t.join(","))}if(e.DOB&&i.push("birthdate="+e.DOB),e.email&&i.push("email:contains="+e.email),!i.length)throw alert(this.__translations.SEARCH_REQUIRES_INPUT),new Error("Failed to perform search due to missing search operator");t+="?"+i.join("&"),window.top.restoreSession();let n={apicsrftoken:this.__apiCSRFToken};return window.fetch(t,{method:"GET",redirect:"manual",headers:n}).then((e=>{if(e.ok&&200==e.status)return e.json();throw this.showActionAlert("danger",this.__translations.OPERATION_FAILED),new Error("Failed to save participant in "+this.pc_eid+" with save data")})).then((e=>0==e.total?(this.showActionAlert("info",this.__translations.SEARCH_RESULTS_NOT_FOUND),[]):e.entry))}showPrimaryScreen(){(this.container.querySelectorAll(".screen")||[]).forEach((e=>{e.classList.contains("primary-screen")?e.classList.remove("d-none"):e.classList.add("d-none")})),this.__currentScreen="primary-screen",this.updateThirdPartyControls()}updateThirdPartyControls(){if(!this.__currentThirdParty)return this.container.querySelector(".no-third-party-patient-row").classList.remove("d-none"),void this.container.querySelector(".third-party-patient-row").classList.add("d-none");this.container.querySelector(".no-third-party-patient-row").classList.add("d-none"),this.container.querySelector(".third-party-patient-row").classList.remove("d-none");let e=this.container.querySelector(".patient-thirdparty");if(e.dataset.pid&&e.dataset.pid!=this.__currentThirdParty.pid){e.dataset.pid=this.__currentThirdParty.pid;let t=(this.__currentThirdParty.fname||"")+" "+(this.__currentThirdParty.lname||"");this.setNodeInnerText(e,".patient-name",t),this.setNodeInnerText(e,".patient-dob",this.__currentThirdParty.DOB),this.setNodeInnerText(e,".patient-email",this.__currentThirdParty.email)}}showNewPatientScreen(){this.showSecondaryScreen("create-patient")}showSearchPatientScreen(){this.showSecondaryScreen("search-patient")}showSecondaryScreen(e){let t="."+e,i=this.container.querySelector(".primary-screen");if(!i)return void console.error("Failed to find primary-screen selector for add-patient-dialog container");i.classList.add("d-none");let n=this.container.querySelector(t);n?n.classList.remove("d-none"):console.error("Failed to find selector for add-patient-dialog container "+t),this.__currentScreen=e}getInputValues(e,t){let i={};return t.forEach((t=>{let n=this.container.querySelector("."+e+' input[name="'+t+'"]');n?i[t]=n.value:(console.error("Failed to find input node with name "+t),i[t]=null)})),i}inviteSearchResultPatient(e){this.displaySearchList(!1),this.showActionAlert("info",this.__translations.PATIENT_INVITATION_PROCESSING),this.sendSaveParticipant({pid:e}).catch((e=>{console.error(e),this.showActionAlert("danger",this.__translations.OPERATION_FAILED),this.displaySearchList(!0)}))}displaySearchList(e){let t=".search-patient .search-patient-list",i=this.container.querySelector(t);i?e?i.classList.remove("d-none"):i.classList.add("d-none"):console.error("Failed to find ",t)}populateSearchResults(e){console.log("populatingSearchResults with result ",e);let t=".search-patient .search-patient-list",i=this.container.querySelector(t);if(!i)return void console.error("Failed to find ",t);i.classList.remove("d-none");let n=i.querySelector(".duplicate-match-row-template"),o=n.parentNode;o.replaceChildren(),o.appendChild(n),e.forEach((e=>{let t=e.resource,i=n.cloneNode(!0);i.classList.remove("duplicate-match-row-template"),o.appendChild(i);let s=t.identifier.find((e=>void 0!==e.type.coding.find((e=>"PT"==e.code)))),a=s.value||"";this.setNodeInnerText(i,".pid",a);let r=t.birthDate;r&&this.setNodeInnerText(i,".dob",r);let l=t.name.find((e=>"official"==e.use));l&&(this.setNodeInnerText(i,".fname",l.given.join(" ")),this.setNodeInnerText(i,".lname",l.family));let c=t.telecom.find((e=>"email"==e.system));c&&this.setNodeInnerText(i,".email",c.value),a&&i.querySelector(".btn-select-patient").addEventListener("click",(()=>{this.inviteSearchResultPatient(a)})),i.classList.remove("d-none")}))}setNodeInnerText(e,t,i){let n=e.querySelector(t);n?n.textContent=i:console.error("Failed to find node with selector "+t)}searchParticipantsAction(){let e=this.getInputValues("search-patient",["fname","lname","DOB","email","pid"]);this.sendSearchResults(e).then((e=>{if(e.length)this.populateSearchResults(e);else{this.populateSearchResults([]);let e=this.__translations.SEARCH_RESULTS_NOT_FOUND;setTimeout((function(){alert(e)}),0)}})).catch((e=>{console.error(e)}))}createPatientAction(){let e=this.getInputValues("create-patient",["fname","lname","DOB","email"]);this.clearActionAlerts(),this.showActionAlert("info",this.__translations.PATIENT_INVITATION_PROCESSING),this.sendSaveParticipant(e).catch((e=>{this.showActionAlert("danger",this.__translations.OPERATION_FAILED),console.error(e)}))}clearActionAlerts(){this.container.querySelectorAll(".alert").forEach((e=>{e.classList.contains("alert-template")?e.classList.add("d-none"):e.parentNode.removeChild(e)}))}showActionAlert(e,t){this.clearActionAlerts();let i=this.container.querySelector(".alert.alert-template"),n=i.cloneNode(!0);n.innerText=t,n.classList.remove("alert-template"),n.classList.remove("d-none"),n.classList.add("alert-"+e),i.parentNode.insertBefore(n,i),n.scrollIntoView()}setupModal(){let e="telehealth-container-invite-patient",t=document.getElementById(e),i=t.cloneNode(!0);i.id=e+"-"+this.__idx++,t.parentNode.appendChild(i),this.container=i,this.modal=new bootstrap.Modal(this.container,{keyboard:!1,focus:!0,backdrop:"static"}),this.addActionToButton(".btn-telehealth-confirm-cancel",this.cancelDialog.bind(this)),this.addActionToButton(".btn-show-new-patient-screen",this.showNewPatientScreen.bind(this)),this.addActionToButton(".btn-show-search-patient-screen",this.showSearchPatientScreen.bind(this)),this.addActionToButton(".btn-cancel-screen-action",this.showPrimaryScreen.bind(this)),this.addActionToButton(".btn-create-patient",this.createPatientAction.bind(this)),this.addActionToButton(".btn-invite-search",this.searchParticipantsAction.bind(this));let n=this.container.querySelector(".btn-invite-search");n?n.addEventListener("click",this.__searchOrAddParticipant):console.error("Could not find selector with .btn-telehealth-confirm-yes"),this.updateThirdPartyControls()}addActionToButton(e,t){let i=this.container.querySelectorAll(e);for(var n=0;n<i.length;n++)i[n].addEventListener("click",t)}show(){this.modal||this.setupModal(),this.modal.show()}destruct(){this.modal=null,this.container.parentNode.removeChild(this.container),this.container=null}}class v{__isMinimized=!1;container=null;participantList=null;videoBar=null;minimizedConferenceNode=null;constructor(e){this.container=e}isMinimized(){return this.__isMinimized}resetConferenceVideoBar(e){this.videoBar&&(this.videoBar.destruct(),this.videoBar=null);let t=this.minimizedConferenceNode.querySelector(".telehealth-button-bar");return this.videoBar=new n(t,e),this.videoBar}minimizeConferenceRoom(e){let t="minimized-telehealth-video-template",i=this.container.querySelector("."+t);if(!i)throw new Error("Failed to find template node with class ."+t);let n=i.cloneNode(!0);n.id="minimized-telehealth-video",n.classList.remove("d-none"),n.classList.remove(t),window.document.body.appendChild(n),this.minimizedConferenceNode=n,this.participantList=this.container.querySelector(".participant-list-container"),n.prepend(this.participantList),this.participantList.dataset.classMinimize&&(this.participantList.className=this.participantList.dataset.classMinimize),window.initDragResize&&window.initDragResize(),this.__isMinimized=!0}maximizeConferenceRoom(){var e=this.container.querySelector(".remote-video-container");if(this.participantList&&e){var t=this.minimizedConferenceNode;this.videoBar.destruct(),e.parentNode.prepend(this.participantList),this.participantList.dataset.classMaximize&&(this.participantList.className=this.participantList.dataset.classMaximize),t&&t.parentNode&&t.parentNode.removeChild(t),this.minimizedConferenceNode=null}else console.error("Failed to find remote video or remote video container");this.__isMinimized=!1}destruct(){this.participantList=null,this.container=null;let e=document.getElementById("minimized-telehealth-video");e&&e.parentNode&&e.parentNode.removeChild(e),this.__isMinimized=!1}}class C{__container=null;__localVideoElement=null;__selectCallbacks=[];__localParticipant=null;__isPinned=!1;constructor(e,t){this.__container=e,this.__localVideoElement=e.querySelector(".local-video"),this.__selectCallbacks=[],this.__isPinned=!1,this.__localParticipant=t,e.addEventListener("click",this.handleSelectEvent.bind(this))}attach(e){this.__localVideoElement.srcObject=e,this.__localVideoElement.play().catch((e=>{console.error("Failed to play local video error object ",e)}))}getRemotePartyId(){return this.__localParticipant?this.__localParticipant.uuid:null}getParticipant(){return this.__localParticipant}getCurrentCallStream(){return this.__localVideoElement?this.__localVideoElement.srcObject:null}setMuted(e){this.__localVideoElement.muted=!0}hasMediaStream(){return this.__localVideoElement&&null!=this.__localVideoElement.srcObject}stop(){this.__localVideoElement&&(this.__localVideoElement.pause(),this.__localVideoElement.srcObject=null)}hide(){this.__container.classList.add("d-none")}show(){this.__container.classList.remove("d-none")}handleSelectEvent(e){this.__selectCallbacks.forEach((e=>e(this)))}addCallerSelectListener(e){this.__selectCallbacks.push(e)}setPinnedStatus(e){this.__isPinned=e,e?this.__container.classList.add("pinned"):this.__container.classList.remove("pinned")}isPinned(){return this.__isPinned}}function b(e,i,o,a){let r=this;function l(e,t,i,n){t?(e.classList.add(i),e.classList.remove(n)):(e.classList.add(n),e.classList.remove(i))}this.apiCSRFToken=e,this.waitingRoomTemplate=null,this.conferenceRoomTemplate=null,this.callerSettings=null,this.features=i,this.telehealthSessionData=null,this.videoBar=null,this.ROOM_TYPE_WAITING="waiting",this.ROOM_TYPE_CONFERENCE="conference",this.dbThresholdSetting=-45,this.buttonSettings={microphoneEnabled:!0,cameraEnabled:!0,screensharingEnabled:!1},this.sessionUpdatePollingTime=5e3,this.room=null,this.waitingRoomModal=null,this.inSession=!1,this.__minimizedConferenceRoom=null,this.sessionUpdateInterval=null,this.__hasLocalPermisions=!1,this.__bridge=null,this.__localCallSlot=null,this.__slots=[],this.__localCaller=null,this.__remoteCaller=null,this.__remoteCallSlot=null,this.__isShutdown=!0,this.__callerIdx=0,this.__maxSlots=3,this.__presentationScreen=null,this.__localScreenshareCalls=[],this.__focusCallerUuid=null,this.__pinnedCallerUuid=null,this.isMinimized=function(){return!!this.__minimizedConferenceRoom&&this.__minimizedConferenceRoom.isMinimized()},this.allocateSlot=function(e,t){if(!e.getUserData()){let n=!0,o=this.__slots.length;for(var i=0;i<o;i++)if(this.__slots[i].isAvailableForCall(e)){this.__slots[i].attach(e,t,this.getParticipantForCall(e)),n=!1;break}if(n&&o<=this.__maxSlots){let i=new s("participant-list-container",this.__callerIdx++);i.addCallerSelectListener((function(e){r.togglePinnedCallerId(e.getRemotePartyId()),r.updateParticipantDisplays()})),this.__slots.push(i),o++,i.attach(e,t,this.getParticipantForCall(e))}1==o&&this.setCurrentCallerFocusId(e.getRemotePartyId()),this.updateParticipantDisplays()}},this.updateParticipantDisplays=function(){if(this.__isShutdown)return;let e=!1,t=this.__slots.length<=1,i=this.isMinimized(),n=this.__pinnedCallerUuid||this.__focusCallerUuid||null;for(var o=0;o<this.__slots.length;o++)this.__slots[o].getRemotePartyId()==n?(e=!0,this.__presentationScreen.attach(this.__slots[o]),t&&!i?this.__slots[o].hide():this.__slots[o].show()):i&&this.__slots[o].getRemotePartyId()==this.getLocalPartyId()?this.__slots[o].hide():this.__slots[o].show();this.__localCallSlot&&(i?this.__localCallSlot.hide():this.__localCallSlot.show()),e||(this.__localCallSlot.getRemotePartyId()==n?this.__presentationScreen.attach(this.__localCallSlot):this.__presentationScreen.detach()),this.hasRemoteParticipants()||this.__isShutdown||this.toggleRemoteVideo(!1),this.__slots.length?this.buttonSettings.screensharingEnabled=!0:this.buttonSettings.screensharingEnabled=!1,this.resetConferenceVideoBar()},this.isAuthorizedParticipant=function(e){return void 0!==(this.callerSettings.participantList||[]).find((t=>t.uuid==e))},this.getRemoteParticipantList=function(){return(this.callerSettings.participantList||[]).filter((e=>e.uuid!==r.callerSettings.callerUuid))},this.getLocalParticipant=function(){return this.findParticipantForId(r.callerSettings.callerUuid)},this.getParticipantForCall=function(e){return this.findParticipantForId(e.getRemotePartyId())},this.findParticipantForId=function(e){return(this.callerSettings.participantList||[]).find((t=>t.uuid==e))},this.setParticipantInCallRoomStatus=function(e,t){if(this.__isShutdown)return;t="Y"==t?"Y":"N";let i=((this.callerSettings||{}).participantList||[]).find((t=>t.uuid==e));i?i.inRoom=t:console.error("participant was not found in participant list for callerId "+e)},this.getLocalPartyId=function(){return r.callerSettings.callerUuid},this.findCallerSlotWithId=function(e){return e==this.callerSettings.callerUuid?this.__localCallSlot:this.__slots.find((t=>t.getRemotePartyId()===e))},this.togglePinnedCallerId=function(e){if(this.__pinnedCallerUuid){let e=this.findCallerSlotWithId(this.__pinnedCallerUuid);e&&e.isPinned()&&e.setPinnedStatus(!1)}if(e!=this.__pinnedCallerUuid){let t=this.findCallerSlotWithId(e);t?(this.__pinnedCallerUuid=e,t.setPinnedStatus(!0),this.setCurrentCallerFocusId(e)):console.error("Failed to find pinned caller slot with uuid "+e)}else this.__pinnedCallerUuid=null},this.setCurrentCallerFocusId=function(e){this.__focusCallerUuid=e},this.getCurrentCallerFocusId=function(){return this.__focusCallerUuid},this.restartMediaStream=function(){return r.__localCallSlot.hasMediaStream()&&r.__bridge.closeLocalMediaStream(),r.__bridge.getLocalMediaStream().then((e=>r.handleLocalMediaStreamStarted(e))).catch((e=>r.handleLocalMediaStreamFailed(e)))},this.handleLocalMediaStreamStarted=function(e){return r.__localCallSlot.attach(e),r.__hasLocalPermisions=!0,r.toggleJoinButton(r.shouldEnableJoinButton()),r.togglePermissionBox(!1),r.__hasLocalPermisions},this.handleLocalMediaStreamFailed=function(e){return console.error(e),r.__hasLocalPermisions=!1,r.toggleJoinButton(r.shouldEnableJoinButton()),r.togglePermissionBox(!0),r.__hasLocalPermisions},this.startBridge=function(){r.__localCallSlot=new C(document.getElementById("local-video-container"),this.getLocalParticipant()),r.__localCallSlot.setMuted(!0),r.__bridge=new g(r.callerSettings.callerUuid,r.callerSettings.apiKey,r.callerSettings.serviceUrl);let e={onincomingcall:r.handleIncomingCall.bind(r),onbridgeactive:e=>{r.restartMediaStream()},onbridgeinactive:e=>{r.__localCallSlot&&r.__localCallSlot.stop()},onbridgefailure:e=>{r.__localCallSlot&&r.__localCallSlot.stop(),alert(o.BRIDGE_FAILED)}};r.__bridge.startBridge(e),r.__isShutdown=!1},this.setCallHandlers=function(e){e.oncallstarted=e=>{r.handleCallStartedEvent(e)},e.onstreamupdated=(e,t)=>{console.log("onstreamupdated "+r.callerSettings.calleeUuid),r.allocateSlot(e,t)},e.oncallended=e=>{r.handleCallEndedEvent(e)},e.isScreenSharing()||e.attachActivityMonitor(r.dbThresholdSetting,(e=>{r.handleActivityEvent(e)}))},this.makeCall=function(e){const t=r.__bridge.createVideoCall(e);return r.setCallHandlers(t),t.oncallrejected=e=>{console.log(e),console.log("oncallrejected "+r.callerSettings.calleeUuid),r.handleCallEndedEvent(e)},t.start().catch((e=>{alert(o.CALL_CONNECT_FAILED),console.log("call exception "+r.callerSettings.calleeUuid),console.error(e),r.handleCallEndedEvent(t)})),t},this.isScreensharing=function(){return this.__localScreenshareCalls.length>0},this.removeLocalScreensharingCall=function(e){let t=this.__localScreenshareCalls.findIndex((t=>t.getRemotePartyId()==e));t>=0&&this.__localScreenshareCalls.splice(t,1)},this.makeScreenshareCall=function(e){const t=r.__bridge.createScreenSharingCall(e);this.__localScreenshareCalls.push(t),t.start().catch((t=>{alert(o.CALL_CONNECT_FAILED),console.log("call exception "+r.callerSettings.calleeUuid),console.error(t),this.removeLocalScreensharingCall(e)})),t.oncallended=t=>{this.removeLocalScreensharingCall(e)}},this.enableMicrophone=function(e){r.__bridge.enableMicrophone(e)},this.enableCamera=function(e){r.__bridge.enableCamera(e)},this.hasLocalPermissionsEnabled=function(){return r.__hasLocalPermisions},this.canReceiveCall=function(e){let t=e.getRemotePartyId();return this.isAuthorizedParticipant(t)?Promise.resolve({call:e,canCall:!0}):Promise.resolve({call:e,canCall:!1})},this.getRemoteScriptLocation=function(){return a},this.getTelehealthLaunchData=function(e){var t=this.getRemoteScriptLocation()+"?action=get_telehealth_launch_data&eid="+encodeURIComponent(e.pc_eid);return window.top.restoreSession(),window.fetch(t,{redirect:"manual"})},this.setupProviderWaitingRoom=function(){let e=this.createModalWithContent(r.waitingRoomTemplate),t=document.getElementById("telehealth-container");r.initWaitingRoomEvents(t),r.waitingRoomModal=e,r.waitingRoomModal.show()},this.setupWaitingRoom=function(){r.setupProviderWaitingRoom()},this.handleIncomingCall=function(e){this.canReceiveCall(e).then((e=>{if(!e.canCall)return console.log("Call from "+e.call.getRemotePartyId()+" not authorized by server for "+r.callerSettings.callerUuid),void e.call.reject();r.setCallHandlers(e.call),e.call.accept(),console.log("Call accepted from "+e.call.getRemotePartyId()+" for "+r.callerSettings.callerUuid),r.toggleRemoteVideo(!0),r.setParticipantInCallRoomStatus(e.call.getRemotePartyId(),"Y")})).catch((t=>{e.reject()}))},this.init=function(e){e.pc_eid?(r.telehealthSessionData=e,r.getTelehealthLaunchData(e).then((function(e){if(!e.ok||200!=e.status)throw new Error("Failed to fetch data");return e.json()})).then((e=>{r.inSession=!0,r.callerSettings=e.callerSettings,r.setCurrentCallerFocusId(e.callerSettings.calleeUuid),r.waitingRoomTemplate=e.waitingRoom,r.conferenceRoomTemplate=e.conferenceRoom,r.setupWaitingRoom(),r.startBridge(),r.room=r.ROOM_TYPE_WAITING})).catch((function(e){console.error(e),r.__bridge||(alert(o.SESSION_LAUNCH_FAILED),r.destruct())}))):alert(o.SESSION_LAUNCH_FAILED)},this.destruct=function(){if(this.__isShutdown)return void console.error("destruct called multiple times.  Ignoring");console.log("conference-room.destruct() called"),r.inSession=!1,r.waitingRoomTemplate=null,r.conferenceRoomTemplate=null,r.videoBar&&(r.videoBar.destruct(),r.videoBar=null),r.room==r.ROOM_TYPE_WAITING||(r.room,r.ROOM_TYPE_CONFERENCE),null!==r.sessionUpdateInterval&&(clearInterval(r.sessionUpdateInterval),r.sessionUpdateInterval=null);let e=document.getElementById("telehealth-container");if(r.__bridge&&r.__bridge.shutdown)try{r.__bridge.shutdown()}catch(e){console.error(e)}e&&e.parentNode&&e.parentNode.removeChild(e),r.isMinimized()&&(this.__minimizedConferenceRoom.destruct(),this.__minimizedConferenceRoom=null),r.callerSettings=null,r.telehealthSessionData=null,r.__isShutdown=!0},this.initModalEvents=function(e){for(var t=document.getElementsByClassName("btn-telehealth-provider-close"),i=0;i<t.length;i++)t[i].addEventListener("click",r.handleCallHangup)},this.initWaitingRoomEvents=function(e){r.videoBar=new n(e,r.getWaitingRoomVideoBarSettings()),r.toggleJoinButton(r.shouldEnableJoinButton())},this.togglePermissionBox=function(e){let t=document.querySelector("#telehealth-container .permissions-box"),i=document.querySelector("#telehealth-container .permissions-box .restart-media-btn");t&&i?e?(i.addEventListener("click",r.recaptureLocalMedia),t.classList.remove("d-none")):(t.classList.add("d-none"),i.removeEventListener("click",r.recaptureLocalMedia)):console.error("Could not find permissions box dom nodes")},this.recaptureLocalMedia=function(){r.__bridge&&!r.__bridge.isShutdown&&r.__bridge.shutdown(),r.startBridge()},this.shouldEnableJoinButton=function(){return r.hasLocalPermissionsEnabled()},this.toggleJoinButton=function(e){let t=document.querySelectorAll(".btn-comlink-conference-join");if(t&&t.length)for(let i=0;i<t.length;i++)e?(t[i].addEventListener("click",r.startConferenceRoom),t[i].classList.remove("disabled"),t[i].disabled=!1):(t[i].removeEventListener("click",r.startConferenceRoom),t[i].classList.add("disabled"),t[i].disabled=!0)},this.sessionClose=function(){let e=this;e.isMinimized()?e.destruct():(jQuery("#telehealth-container").on("hidden.bs.modal",(function(){jQuery("#telehealth-container").off("hidden.bs.modal"),e.destruct()})),e.waitingRoomModal.hide())},this.confirmSessionClose=function(){r.room==r.ROOM_TYPE_WAITING?r.sessionClose():new t(o,r.telehealthSessionData.pc_eid,r.getRemoteScriptLocation(),(function(){r.sessionClose()})).show()},this.shutdownProviderWaitingRoom=function(){let e=document.getElementById("telehealth-container");if(r.__bridge&&r.__bridge.shutdown)try{r.__bridge.shutdown()}catch(e){console.error(e)}e&&e.parentNode&&e.parentNode.removeChild(e),r.callerSettings=null,r.telehealthSessionData=null},this.createModalWithContent=function(e){let t=window.document.createElement("div");t.innerHTML='<div class="modal fade" id="telehealth-container" tabindex="-1" aria-hidden="true">\n              <div class="modal-dialog mw-100 ml-2 mr-2">\n                <div class="modal-content">\n                  <div class="modal-header">\n                    <h5 class="modal-title">'+jsText(o.TELEHEALTH_MODAL_TITLE)+`</h5>\n                    <button type="button" class="close btn-telehealth-provider-close" aria-label="Close">\n                      <span aria-hidden="true">&times;</span>\n                    </button>\n                  </div>\n                  <div class="modal-body d-flex">\n                  ${e}\n                  </div>\n                </div>\n              </div>\n            </div>`,window.document.body.appendChild(t.firstElementChild);var i=document.getElementById("telehealth-container");return r.waitingRoomModal=new bootstrap.Modal(i,{keyboard:!1,focus:!0,backdrop:"static"}),r.initModalEvents(i),r.waitingRoomModal},this.startConferenceRoom=function(){r.startProviderConferenceRoom()},this.startProviderConferenceRoom=function(){let e=document.getElementById("telehealth-container");r.videoBar.destruct();let t=e.querySelector(".modal-body");do{t.removeChild(t.firstChild)}while(t.childNodes.length);t.innerHTML=r.conferenceRoomTemplate;let i=new C(e.querySelector(".local-participant"),this.getLocalParticipant());i.attach(this.__localCallSlot.getCurrentCallStream()),i.addCallerSelectListener((e=>{r.togglePinnedCallerId(e.getRemotePartyId()),r.updateParticipantDisplays()})),this.__localCallSlot=i,r.videoBar=new n(this.getVideoBarContainer(),r.getFullConferenceVideoBarSettings()),r.inConferenceRoom=!0,r.room=r.ROOM_TYPE_CONFERENCE,this.sessionUpdateInterval=setInterval(r.updateConferenceRoomSession.bind(r),r.sessionUpdatePollingTime),this.__presentationScreen=new S("presentation-screen"),r.updateConferenceRoomSession()},this.updateConferenceRoomSession=function(){let e=(r.callerSettings.appointment||{}).eid||{};window.top.restoreSession(),window.fetch(r.getRemoteScriptLocation()+"?action=conference_session_update&eid="+encodeURIComponent(e),{redirect:"manual"}).then((e=>{if(e.ok)return e.json();throw new Error("Failed to update session")})).catch((e=>console.error("Conference session update ",e)))},this.cancelUpdateConferenceRoomSession=function(){r.sessionUpdateInterval&&window.clearInterval(r.sessionUpdateInterval)},this.getDefaultVideoBarSettings=function(){var e=function(){};return{notes:!1,notesCallback:e,microphone:r.buttonSettings.microphoneEnabled,microphoneCallback:r.toggleMicrophone.bind(r),video:r.buttonSettings.cameraEnabled,videoCallback:r.toggleVideo.bind(r),expand:!1,expandCallback:e,hangup:!1,hangupCallback:e,screenshare:r.buttonSettings.screensharingEnabled,screenshareCallback:r.toggleScreenSharing.bind(r)}},this.getWaitingRoomVideoBarSettings=function(){return r.getDefaultVideoBarSettings()},this.getMinimizedConferenceVideoBarSettings=function(){let e=r.getDefaultVideoBarSettings();return e.expandCallback=r.maximizeProviderConferenceCall.bind(r),e.hangupCallback=r.handleCallHangup.bind(r),e.expand=!0,e.notes=!1,e.hangup=!0,e.screenshare=!0,e},this.addSettingsForScreenshare=function(e){this.__slots.length?e.screenshare=!0:e.screenshare=!1},this.addSettingsForThirdPartyInvitations=function(e){r.features&&r.features.thirdPartyInvitations?(e.invite=!0,e.inviteCallback=r.handleInviteCallback.bind(r)):e.invite=!1},this.getFullConferenceVideoBarSettings=function(){let e=r.getDefaultVideoBarSettings();return e.hangupCallback=r.handleCallHangup.bind(r),e.notesCallback=r.minimizeProviderConferenceCall.bind(r),e.expand=!1,e.notes=!0,e.hangup=!0,r.addSettingsForThirdPartyInvitations(e),r.addSettingsForScreenshare(e),e},this.handleInviteCallback=function(){new f(this.apiCSRFToken,o,r.telehealthSessionData.pc_eid,r.getRemoteScriptLocation(),r.callerSettings.thirdPartyPatient,(function(e){e&&(r.callerSettings=e)})).show()},this.handleCallStartedEvent=function(e){r.toggleRemoteVideo(!0)},this.resetConferenceVideoBar=function(){r.videoBar&&r.videoBar.destruct(),r.__isShutdown||(this.isMinimized()?r.videoBar=this.__minimizedConferenceRoom.resetConferenceVideoBar(r.getMinimizedConferenceVideoBarSettings()):r.videoBar=new n(this.getVideoBarContainer(),r.getFullConferenceVideoBarSettings()))},this.getVideoBarContainer=function(){return document.getElementById("telehealth-container").querySelector(".conference-room .telehealth-button-bar")},this.removeCallFromConference=function(e){if(null!=e.getUserData()){let t=e.getUserData();e.isScreenSharing()?t.detachScreenshare():(this.removeSlotForCall(e),r.setParticipantInCallRoomStatus(e.getRemotePartyId(),"N")),this.updateParticipantDisplays()}},this.removeSlotForCall=function(e){if(null!=e.getUserData()){let t=e.getUserData(),i=t.getRemotePartyId();t.destruct(),this.__slots=this.__slots.filter((e=>e!==t)),i==this.__pinnedCallerUuid&&this.togglePinnedCallerId(i),this.__slots.length&&this.getCurrentCallerFocusId()==i&&this.setCurrentCallerFocusId(this.__slots[0].getRemotePartyId())}},this.hasRemoteParticipants=function(){return this.__slots.length>0},this.handleCallEndedEvent=function(e){r.removeCallFromConference(e)},this.handleActivityEvent=function(e){this.setCurrentCallerFocusId(e.getRemotePartyId()),this.updateParticipantDisplays()},this.handleCallHangup=function(){r.isMinimized()&&r.maximizeProviderConferenceCall({}),r.confirmSessionClose()},this.minimizeProviderConferenceCall=function(){this.__minimizedConferenceRoom=new v(document.getElementById("telehealth-container")),this.__minimizedConferenceRoom.minimizeConferenceRoom(this.getMinimizedConferenceVideoBarSettings()),this.resetConferenceVideoBar(),r.waitingRoomModal.hide(),this.updateParticipantDisplays()},this.maximizeProviderConferenceCall=function(e){this.isMinimized()&&(this.__minimizedConferenceRoom.maximizeConferenceRoom(),this.__minimizedConferenceRoom.destruct(),this.__minimizedConferenceRoom=null,r.waitingRoomModal?r.waitingRoomModal.show():console.error("Failed to find waitingRoomModal")),this.updateParticipantDisplays()},this.toggleMicrophone=function(e){let t=e.target;t.classList.contains("fa")||(t=t.querySelector(".fa"));let i=!r.buttonSettings.microphoneEnabled;r.buttonSettings.microphoneEnabled=i,t.dataset.enabled=i,r.__bridge&&r.__bridge.enableMicrophone?r.__bridge.enableMicrophone(i):console.error("__bridge is not initalized and cannot toggle microphone"),l(t,i,"fa-microphone","fa-microphone-slash")},this.toggleVideo=function(e){let t=e.target;t.classList.contains("fa")||(t=t.querySelector(".fa"));let i=!r.buttonSettings.cameraEnabled;r.buttonSettings.cameraEnabled=i,t.dataset.enabled=i,r.__bridge&&r.__bridge.enableCamera?r.__bridge.enableCamera(i):console.error("app is not initalized and cannot toggle microphone"),l(t,i,"fa-video","fa-video-slash")},this.toggleRemoteVideo=function(e){var t=document.getElementById("telehealth-container").querySelector(".waiting-container");e?(t.classList.add("d-none"),this.__presentationScreen.show()):(t.classList.remove("d-none"),this.__presentationScreen.hide())},this.toggleScreenSharing=function(e){this.getRemoteParticipantList().forEach((e=>{"Y"==e.inRoom&&this.makeScreenshareCall(e.uuid)}))}}function w(e,t,i,n){let o=new b(e,t,i,n),s=o.destruct,a=null,r=!1;function l(){let e=o.telehealthSessionData.pc_eid;window.top.restoreSession(),window.fetch(n+"?action=patient_appointment_ready&eid="+encodeURIComponent(e),{redirect:"manual"}).then((e=>{if(e.ok)return e.json();throw new Error("Failed to get response back from server")})).then((e=>{if(e.session){if(r="1"===e.session.providerReady,e.session.participantList){o.callerSettings.participantList=e.session.participantList;let t=o.callerSettings.participantList.find((e=>"provider"==e.role));if(!t)throw new Error("No provider in participant list.  Provider is not ready and cannot continue");o.callerSettings.calleeUuid=t.uuid,o.setCurrentCallerFocusId(t.uuid)}o.toggleJoinButton(o.shouldEnableJoinButton())}})).catch((e=>{let t=document.querySelector(".waiting-room-server-communication");t&&t.classList.remove("d-none"),console.error(e)}))}return o.getFullConferenceVideoBarSettings=function(){let e=o.getDefaultVideoBarSettings();return e.hangupCallback=o.handleCallHangup.bind(o),e.expand=!1,e.notes=!1,e.invite=!1,e.hangup=!0,o.addSettingsForScreenshare(e),e},o.startConferenceRoom=function(){o.stopProviderReadyCheck(),o.startProviderConferenceRoom();let e=o.getRemoteParticipantList();e&&e.forEach((e=>{"Y"==e.inRoom&&(e.role,o.makeCall(e.uuid))}))},o.canReceiveCall=function(e){let t=e.getRemotePartyId();console.log("Received call ",e);let i=o.isAuthorizedParticipant(t);return Promise.resolve({call:e,canCall:i})},o.handleCallEndedEvent=function(e){try{let t=null;null!=e.getUserData()&&(t=e.getUserData().getRemotePartyId(),o.removeCallFromConference(e))}catch(e){console.error("Failed to remove call on call ended event",e)}o.inSession&&!o.hasProviderParticipant()&&(o.buttonSettings.screensharingEnabled=!1,alert(i.HOST_LEFT),o.replaceConferenceRoomWithWaitingRoom(),o.cancelUpdateConferenceRoomSession())},o.hasProviderParticipant=function(){return void 0!==o.findCallerSlotWithId(o.callerSettings.calleeUuid)},o.replaceConferenceRoomWithWaitingRoom=function(){o.telehealthSessionData,o.waitingRoomModal;var e=document.getElementById("telehealth-container"),t=e.querySelector(".modal-body"),i=document.getElementById("local-video");o.videoBar.destruct(),t.innerHTML=o.waitingRoomTemplate;var n=document.getElementById("local-video");n?(n.parentNode.replaceChild(i,n),r=!1,o.initWaitingRoomEvents(e),o.startProviderReadyCheck()):console.error("Failed to find child video to replace")},o.handleCallHangup=function(){(o.room==o.ROOM_TYPE_WAITING||confirm(i.CONFIRM_SESSION_CLOSE))&&o.sessionClose()},o.setWaitingRoomModal=function(e){o.waitingRoomModal=e},o.setupWaitingRoom=function(){o.setupProviderWaitingRoom(),o.startProviderReadyCheck()},o.destruct=function(){o.stopProviderReadyCheck(),window.dlgclose&&window.dlgclose(),s.bind(o)()},o.stopProviderReadyCheck=function(){a&&(clearInterval(a),a=null)},o.startProviderReadyCheck=function(){a=setInterval(l,2e3)},o.shouldEnableJoinButton=function(){return r&&o.hasLocalPermissionsEnabled()},o}!function(t,i,n,o){let s=!1;i.settings=i.settings||{};let a=i.settings.modulePath||"/interface/modules/custom_modules/oe-module-comlink-telehealth/",r=null,l=i.translations||{CALL_CONNECT_FAILED:"Failed to connect the call.",SESSION_LAUNCH_FAILED:"There was an error in launching your telehealth session.  Please try again or contact support",APPOINTMENT_STATUS_UPDATE_FAILED:"There was an error in saving the telehealth appointment status.  Please contact support or update the appointment manually in the calendar",DUPLICATE_SESSION:"You are already in a conference session.  Please hangup the current call to start a new telehealth session",HOST_LEFT:"Host left the call",CONFIRM_SESSION_CLOSE:"Are you sure you want to close this session?",TELEHEALTH_MODAL_TITLE:"TeleHealth Session",TELEHEALTH_MODAL_CONFIRM_TITLE:"Confirm Session Close",UPDATE_APPOINTMENT_STATUS:"Update appointment status",STATUS_NO_SHOW:"No Show",STATUS_CANCELED:"Canceled",STATUS_CHECKED_OUT:"Checked Out",STATUS_SKIP_UPDATE:"Skip Update",CONFIRM:"Confirm",STATUS_NO_UPDATE:"No Change",STATUS_OTHER:"Other"};function c(e){return!0===e?a+"public/index-portal.php":a+"public/index.php"}i.telehealth={showPatientPortalDialog:function(e){let t={pc_eid:e},n=i.settings.apiCSRFToken;s=new w(n,i.settings.features,l,c(!0)),s.init(t)},launchProviderVideoMessage:function(e){if(s){if(s.inSession)return void alert(l.DUPLICATE_SESSION);s.destruct(),s=null}s=new b(i.settings.apiCSRFToken,i.settings.features,l,c(!1)),s.init(e)},launchRegistrationChecker:function(t){r=new e(c(t)),r.checkRegistration()}},t.comlink=i}(window,window.comlink||{},bootstrap,$,window.dlgopen)}();