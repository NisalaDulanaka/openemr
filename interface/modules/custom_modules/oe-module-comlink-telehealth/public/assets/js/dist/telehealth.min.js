/*! For license information please see telehealth.min.js.LICENSE.txt */
!function(){"use strict";function e(e){var t=this,i=0;return this.checkRegistration=function(){if(i++>10)return void console.error("Failed to get a valid telehealth registration for user");let n=e+"?action=check_registration";window.top.restoreSession(),window.fetch(n).then((e=>{if(!e.ok)throw new Error("Registration check failed");return e.json()})).then((e=>{e&&e.hasOwnProperty("errorCode")&&402==e.errorCode&&(t.settings={}),t.settings=e})).catch((e=>{console.error("Failed to execute check_registration action",e),setTimeout(t.checkRegistration.bind(t),2e3)}))},this}function t(e,t,i){let n=this,o=null,s=null;this.cancelDialog=function(){let e=s.querySelectorAll(".hangup-section"),t=s.querySelector(".hangup-section.hangup-section-start");if(e&&e.length)for(let t=0;t<e.length;t++)e[t].classList.add("d-none");t&&t.classList.remove("d-none"),o.hide()},this.processConfirmYesAction=function(e){s.querySelector(".row-confirm").classList.add("d-none"),s.querySelector(".row-update-status").classList.remove("d-none")},this.sendAppointmentStatusUpdate=function(i){console.log("Setting appointment to status ",i);let n="action=set_appointment_status&pc_eid="+encodeURIComponent(e)+"&status="+encodeURIComponent(i);window.top.restoreSession(),window.fetch(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n,redirect:"manual"}).then((t=>{t.ok&&200==t.status||(alert(translations.APPOINTMENT_STATUS_UPDATE_FAILED),console.error("Failed to update appointment "+e+" to status "+i))}))},this.updateAppointmentStatusAndClose=function(e){jQuery(s).on("hidden.bs.modal",(function(){try{jQuery(s).off("hidden.bs.modal"),i()}catch(e){console.error(e)}try{"CloseWithoutUpdating"!=e&&n.sendAppointmentStatusUpdate(e)}catch(e){console.error(e)}})),o.hide()},this.processHangupSetting=function(e){let t=e.currentTarget.dataset.status||"CloseWithoutUpdating";n.updateAppointmentStatusAndClose(t)},this.processSetStatusFromSelector=function(e){let t=s.querySelector(".appointment-status-update");t&&t.value?n.updateAppointmentStatusAndClose(t.value):console.error("Failed to find selector .appointment-status-update node or value is not defined for node")},this.show=function(){s=document.getElementById("telehealth-container-hangup-confirm"),o=new bootstrap.Modal(s,{keyboard:!1,focus:!0,backdrop:"static"});let e=s.querySelectorAll(".btn-telehealth-confirm-cancel");for(var t=0;t<e.length;t++)e[t].addEventListener("click",n.cancelDialog);let i=s.querySelector(".btn-telehealth-confirm-yes");i?i.addEventListener("click",n.processConfirmYesAction):console.error("Could not find selector with .btn-telehealth-confirm-yes");let a=s.querySelector(".btn-telehealth-session-select-update");for(a&&a.addEventListener("click",n.processSetStatusFromSelector),e=s.querySelectorAll(".btn-telehealth-session-close"),t=0;t<e.length;t++)e[t].addEventListener("click",n.processHangupSetting);o.show()}}function i(e,t,i){let n=this;return n.node=e,n.value=t,n.callback=i,n.enabled=!0===t,n.init=function(){n.enabled?n.attach():n.detatch()},n.attach=function(){this.node&&(this.node.addEventListener("click",this.callback),this.node.classList.remove("d-none"))},n.detatch=function(){this.node&&(this.node.removeEventListener("click",this.callback),this.node.classList.add("d-none"))},n.destruct=function(){n.detatch(),n.node=null,n.callback=null},n.toggle=function(){n.enabled=!n.enabled,n.enabled?this.attach():this.detatch()},n.init(),n}function n(e,t){var n=this;function o(){}function s(e,t,i){e.hasOwnProperty(t)||(e[t]=i)}return n.__buttons={},n.__container=e,n.init=function(){if(s(t=t||{},"notes",!1),s(t,"notesCallback",o),s(t,"microphone",!0),s(t,"microphoneCallback",o),s(t,"video",!0),s(t,"videoCallback",o),s(t,"expand",!1),s(t,"expandCallback",o),s(t,"hangup",!1),s(t,"hangupCallback",o),s(t,"screenshare",!0),s(t,"screenshareCallback",o),["notes","microphone","video","expand","hangup","screenshare"].forEach((e=>{let s=n.__container.querySelector(".telehealth-btn-"+e),a=t[e+"Callback"]||o;s?n.__buttons[e]=new i(s,t[e],a):console.error("Failed to find node for telehealth-btn-"+e)})),!n.__buttons.microphone.enabled){let e=n.__buttons.microphone,t=e.node.querySelector(".fa");e&&t?(e.toggle(),t.classList.add("fa-microphone-slash"),t.classList.remove("fa-microphone")):console.error("Failed to find microphone node and fa icon")}if(!n.__buttons.video.enabled){let e=n.__buttons.video,t=e.node.querySelector(".fa");e&&t?(e.toggle(),t.classList.add("fa-video-slash"),t.classList.remove("fa-video")):console.error("Failed to find video node and fa icon")}},n.destruct=function(){Object.values(n.__buttons).forEach((e=>e.detatch())),n.__container=null},n.toggleButtons=function(e){e.forEach((e=>{n.__buttons[e]?n.__buttons[e].toggle():console.error("Failed to find button to toggle for button "+e)}))},n.init(),n}function o(e){if(this.__call=null,this.__video=document.getElementById(e),!this.__video)throw new Error("Failed to find #"+e+" element");this.isAvailable=function(){return null==this.__call},this.getRemotePartyId=function(){return this.__call?this.__call.remotePartyId():null},this.attach=function(e,t){if(this.__call=e,null==e||null==t)throw console.error("Call or stream were null.  Cannot proceed",{call:e,stream:t}),new Error("call and stream cannot be null");this.__call.setUserData(this),this.__video.srcObject=t,this.__video.play()},this.detach=function(){this.__call.setUserData(null),this.__call=null,this.__video.srcObject=null},this.hide=function(){this.__video.classList.add("d-none")},this.show=function(){this.__video&&this.__video.classList.remove("d-none")}}function s(e,t){this.__videoSlot=new o(e),this.__screenshareSlot=new o(t),this.isAvailable=function(){return this.__videoSlot.isAvailable()},this.isAvailableForCall=function(e){return this.__videoSlot.getRemotePartyId()==e.getRemotePartyId()},this.attach=function(i,n){if(null==i||null==n)throw console.error("Call or stream were null.  Cannot proceed",{call:i,stream:n}),new Error("call and stream cannot be null");i.isScreenSharing()?(this.__screenshareSlot.isAvailable()||(this.__screenshareSlot.detach(),this.__screenshareSlot=new o(t)),this.__screenshareSlot.attach(i,n)):(this.__videoSlot.isAvailable()||(this.__videoSlot.detach(),this.__videoSlot=new o(e)),this.__videoSlot.attach(i,n))},this.showScreenshare=function(){this.__videoSlot.hide(),this.__screenshareSlot.show()},this.showVideo=function(){this.__videoSlot.show(),this.__screenshareSlot.hide()},this.detachScreenshare=function(){this.__screenshareSlot.detach(),this.__screenshareSlot=null,this.showVideo()},this.detatchVideo=function(){this.__videoSlot.detach()},this.detach=function(){this.detachScreenshare(),this.detatchVideo()}}function a(e,t){if(!e)throw new Error(t)}class l{static invokeAndIgnoreExceptions(e){try{e()}catch(e){console.log("Ignoring exception in user callback: "+e)}}}class r{constructor(e){this.t=e,this.i="",this.h=new TextDecoder("utf-8"),this.o=!1}cancel(){this.t.cancel()}eof(){return this.o}l(){const e=this.i.indexOf("\r\n");if(-1==e)return null;const t=this.i.substr(0,e);return this.i=this.i.substr(e+2),t}u(){return this.t.read().then((e=>{if(e.done)return this.o=!0,Promise.resolve(this.i);this.i+=this.h.decode(e.value);const t=this.l();return t?Promise.resolve(t):this.u()}))}readEvent(){if(this.o)return Promise.reject();const e=this.l();return e?Promise.resolve(e):this.u()}}class c{constructor(e){this._=e}v(e,t){return fetch(this._+e,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((e=>e.ok?e.json():Promise.reject(e.status)))}p(e,t){return fetch(this._+e,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}createBridge(e,t,i){const n={userId:e,passwordHash:t,type:i};return fetch(this._+"/client/createBridge",{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}invite(e){return this.p("/client/invite",{callId:e})}call(e,t,i){return this.v("/client/call",{callerId:e,calleeId:t,isScreenSharing:i})}accept(e,t){return this.p("/client/accept",{callId:e,token:t})}reject(e,t){return this.p("/client/reject",{callId:e,token:t})}offer(e,t,i){return this.p("/client/offer",{callId:e,sdp:i,token:t})}answer(e,t,i){return this.p("/client/answer",{callId:e,sdp:i,token:t})}ice(e,t,i){return this.p("/client/ice",{callId:e,candidate:t,token:i})}end(e,t){return this.p("/client/end",{callId:e,token:t})}}const d=new class{constructor(){this.g=[],this.I=0,this.C=-1}m(){this.g.forEach((e=>e.func()))}S(){this.C=setInterval((()=>this.m()),1e3)}k(){clearInterval(this.C),this.C=-1}addTask(e){const t=this.I++,i={id:t,func:e};return this.g.push(i),1==this.g.length&&this.S(),t}removeTask(e){const t=this.g.findIndex((t=>t.id==e));-1!=t&&(this.g.splice(t,1),0==this.g.length&&this.k())}},h=new class{newAudioContext(){return new(window.AudioContext||window.webkitAudioContext)}};class u{constructor(){this.P=-1,this.V=h.newAudioContext(),this.T=this.V.createAnalyser(),this.T.fftSize=2048,this.A=new Uint8Array(this.T.frequencyBinCount),this.L=null,this.db=0,this.ondbthresholdexceeded=e=>{},this.dbthreshold=65}connect(e){-1==this.P&&(this.P=d.addTask((()=>this.j()))),this.L&&this.L.disconnect(),this.L=this.V.createMediaStreamSource(e),this.L.connect(this.T)}disconnect(){-1!=this.P&&(d.removeTask(this.P),this.L.disconnect(),this.L=null,this.P=-1)}j(){const e=this.A.length;let t=0;this.T.getByteTimeDomainData(this.A);for(let i=0;i<e;i++){const e=.0078125*(this.A[i]-128);t+=e*e}this.db=10*Math.log10(t/e),console.log("db="+this.db),this.db>=this.dbthreshold&&l.invokeAndIgnoreExceptions((()=>this.ondbthresholdexceeded(this)))}}const g="Copyright (c) 2022 Comlink Inc.";class m{constructor(e){this.B=e.isInbound,this.O=e.isScreenSharing,this.U=e.remotePartyId,this.R=e.bridge,this.M=e.callId,this.N=e.config,this.D=e.token,this.J=null,this.H=null,this.K=null,this.t=null,this.F=null,this.G=null,this.W=[],e.isInbound?this.q=1:this.q=0,this.oncallstarted=e=>this.X("Unhandled event: call started: "+e.M),this.oncallrejected=e=>this.X("Unhandled event: call rejected: "+e.M),this.oncallended=e=>this.X("Unhandled event: call ended: "+e.M),this.onstreamupdated=(e,t)=>this.X("Unhandled event: stream updated: "+e.M),this.onparticipantlistupdated=(e,t)=>this.X("Unhandled event: participant list updated: "+e.M),this.onviewportlayoutupdated=(e,t)=>this.X("Unahndled event: viewport layout updated: "+t),this.onfacialrecognizerresults=(e,t)=>this.X("Unhandled event: facial recognizer results: "+t)}Y(e){console.log("VC/"+this.M+": "+e)}Z(e){console.error("VC/"+this.M+": "+e)}X(e){console.warn("VC/"+this.M+": "+e)}$(){return this.J=new RTCPeerConnection(this.N),this.J.onicecandidate=e=>this.tt(e),this.J.ontrack=e=>this.it(e),this.O?this.B?Promise.resolve(this):this.st():this.et()}et(){return this.R.getLocalMediaStream().then((e=>{e.getTracks().forEach((t=>this.J.addTrack(t,e)))}))}st(){return navigator.mediaDevices.getDisplayMedia({video:{cursor:"always"},audio:!0}).then((e=>{e.getTracks().forEach((t=>this.J.addTrack(t,e)))}))}ht(){this.K&&(this.K.disconnect(),this.K=null),this.q=6,this.R.nt(this),this.J.close()}rt(e){switch(a("CALL"==e.type,'Bad event type. "CALL" expected.'),e.name){case"accept":this.ot();break;case"end":this.ct();break;case"reject":this.lt();break;case"sdp":this.dt(e.sdp,e.action);break;case"ice":this.ut(e.iceCandidate);break;case"participants":this._t(e.userIds);break;case"viewportLayout":this.vt({frameWidth:e.frameWidth,frameHeight:e.frameHeight,viewports:e.viewports});break;case"facialRecognition":this.gt({callId:e.tagCallId,tag:e.tag,confidence:e.confidence});break;default:throw new Error("Bad call state")}}_t(e){this.F=e,l.invokeAndIgnoreExceptions((()=>this.onparticipantlistupdated(this,this.F)))}vt(e){this.G=e,l.invokeAndIgnoreExceptions((()=>this.onviewportlayoutupdated(this,this.G)))}gt(e){l.invokeAndIgnoreExceptions((()=>this.onfacialrecognizerresults(this,e)))}ut(e){this.J.remoteDescription?this.J.addIceCandidate(e):this.W.push(e)}it(e){this.t=e.streams[0],this.K&&this.K.connect(this.t),l.invokeAndIgnoreExceptions((()=>this.onstreamupdated(this,this.t)))}ct(){l.invokeAndIgnoreExceptions((()=>this.oncallended(this))),this.ht()}ot(){this.J.createOffer({offerToReceiveVideo:!0,offerToReceiveAudio:!0}).then((e=>this.J.setLocalDescription(e))).then((()=>this.R.bt.offer(this.M,this.D,this.J.localDescription.sdp))).catch((e=>{throw this.ft(e),e})),l.invokeAndIgnoreExceptions((()=>this.oncallstarted(this)))}lt(){this.R.nt(this),this.q=4,l.invokeAndIgnoreExceptions((()=>this.oncallrejected(this)))}dt(e,t){const i=new RTCSessionDescription({type:t,sdp:e});"offer"==t?this.J.setRemoteDescription(i).then((()=>(this.wt(),this.J.createAnswer()))).then((e=>this.J.setLocalDescription(e))).then((()=>this.R.bt.answer(this.M,this.D,this.J.localDescription.sdp))).then((e=>(this.q=3,e))).catch((e=>{throw this.ft(e),e})):"answer"==t&&this.J.setRemoteDescription(i).then((()=>{this.wt(),this.q=3})).catch((e=>{throw this.ft(e),e}))}wt(){this.W.forEach((e=>{this.J.addIceCandidate(e)})),this.W=[]}tt(e){if(e.candidate)try{this.R.bt.ice(this.M,e.candidate,this.D)}catch(e){this.X("failed to transmit ICE candidate")}}ft(e){this.q=4,this.Z("panic: "+e.message)}getParticipantList(){return this.F}getViewportLayout(){return this.G}getCallId(){return this.M}getVideoBridge(){return this.R}getRemotePartyId(){return this.U}isInbound(){return this.B}setUserData(e){this.H=e}getUserData(){return this.H}isScreenSharing(){return this.O}attachActivityMonitor(e,t){a(null==this.K,"Activity notifier already attached"),a(null!=t,"Activity monitor callback not defined"),this.K=new u,this.K.dbtheshold=e,this.K.ondbthresholdexceeded=e=>l.invokeAndIgnoreExceptions((()=>t(this))),this.t&&this.K.connect(this.t)}getSoundLevel(){return this.K||this.K.db}start(){return a(0==this.q,"Call already initialized"),this.q=1,this.Y("starting"),this.R.bt.call(this.R.getUserId(),this.U,this.O).then((e=>(this.M=e.callId,this.N=e.config,this.D=e.token,this.$()))).then((()=>this.R.bt.invite(this.M))).then((()=>(this.q=2,this.R.It(this),this))).catch((e=>{throw this.ft(e),e}))}accept(){return a(1==this.q,"Invalid call state"),this.Y("accepting"),this.$().then((()=>this.R.bt.accept(this.M,this.D))).then((e=>(this.q=2,this))).catch((e=>{throw this.ft(e),e}))}reject(){return a(1==this.q,"Invalid call state"),this.Y("rejecting"),this.R.bt.reject(this.M,this.D).then((e=>(this.q=5,this.R.nt(this),this))).catch((e=>{throw this.ft(e),e}))}stop(){return 6!=this.q&&4!=this.q?(this.ht(),this.R.bt.end(this.M,this.D).then((()=>this))):Promise.resolve(this)}muteRemoteAudio(e){a("boolean"==typeof e,"Expected a boolean value"),this.J.getReceivers().forEach((t=>{"audio"==t.track.kind&&(t.track.enabled=e)}))}}class p{constructor(e){this.yt=e.userId,this.Ct=e.type,this.St=e.passwordHash,this.bt=new c(e.serviceUrl||""),this.kt=!1,this.Et={},this.Pt=!1,this.Vt=!1,this.Tt=null,this.At=null,this.onbridgeactive=e=>console.log("onbridgeactive event not handled"),this.onbridgeinactive=e=>console.log("onbridgeinactive event not handled"),this.onbridgefailure=e=>console.log("onbridgefailure event not handled"),this.onincomingcall=e=>{console.log("Inbound call event not handled; call rejected."),e.reject()}}ft(e){console.log("Catastrophic bridge failure: "+e),l.invokeAndIgnoreExceptions((()=>this.onbridgefailure(this))),this.shutdown()}Lt(){this.kt?this.ft(new Error("Event stream closed unexpectedly")):(l.invokeAndIgnoreExceptions((()=>this.onbridgeinactive(this))),this.shutdown())}jt(){this.Tt.readEvent().then((e=>{if(this.Tt.eof())this.Lt();else{try{const t=JSON.parse(e);this.rt(t)}catch(e){return void this.ft(e)}this.jt()}}))}Bt(e){const t=this.Et[e.callId];t?t.rt(e):console.log("Invalid call identifier in the event stream: "+e.callId)}Ot(e){const t=new m({bridge:this,callId:e.callId,isInbound:!0,isScreenSharing:e.isScreenSharing,remotePartyId:e.callerId,config:e.config,token:e.token});this.It(t),l.invokeAndIgnoreExceptions((()=>this.onincomingcall(t)))}Ut(e){this.kt||(this.kt=!0,l.invokeAndIgnoreExceptions((()=>this.onbridgeactive(this))))}rt(e){switch(console.log(e),e.type){case"INCOMING":this.Ot(e);break;case"KEEPALIVE":this.Ut(e);break;case"CALL":this.Bt(e);break;default:this.ft(new Error("Bad event type: "+e.type+". Corrupt stream?"))}}xt(){Object.values(this.Et).forEach((e=>e.ht())),this.Et={}}It(e){this.Et[e.getCallId()]=e}nt(e){const t=e.getCallId();this.Et.hasOwnProperty(t)&&delete this.Et[t]}getUserId(){return this.yt}getCalls(){return Object.values(this.Et)}hasCamera(){return this.Pt}hasMicrophone(){return this.Vt}getCallById(e){return this.Et[e]}isActive(){return this.kt}getLocalMediaStream(){return a(this.kt,"VideoBridge not active"),this.At?Promise.resolve(this.At):navigator.mediaDevices.enumerateDevices().then((e=>{var t={};return null!=e.find((e=>"videoinput"==e.kind))&&(this.Pt=!0,t.video={width:800,height:600}),null!=e.find((e=>"audioinput"==e.kind))&&(this.Vt=!0,t.audio={channels:1}),navigator.mediaDevices.getUserMedia(t)})).then((e=>(this.At=e,e)))}closeLocalMediaStream(){a(this.kt,"VideoBridge not active"),this.At&&(this.At.getTracks().forEach((e=>e.stop())),this.At=null,this.Vt=!1,this.Pt=!1)}enableCamera(e){a(this.kt,"Video bridge not active"),a("boolean"==typeof e,"Expected a boolean value"),this.Pt&&this.At.getTracks().forEach((t=>{"live"==t.readyState&&"video"===t.kind&&(t.enabled=e)}))}enableMicrophone(e){a(this.kt,"Video bridge not active"),a("boolean"==typeof e,"Expected a boolean value"),this.Vt&&this.At.getTracks().forEach((t=>{"live"==t.readyState&&"audio"===t.kind&&(t.enabled=e)}))}start(){a(!this.kt,"Video bridge already active"),console.log("CVB v1.1. "+g),this.bt.createBridge(this.yt,this.St,this.Ct).then((e=>e.body)).then((e=>{this.Tt=new r(e.getReader()),this.jt()})).catch((e=>{console.error("Video bridge creation failure: "+e),l.invokeAndIgnoreExceptions((()=>this.onbridgefailure(this))),this.ft(e)}))}shutdown(){a(this.kt,"Video bridge not active"),console.log("CVB v1.1. "+g),Object.values(this.Et).forEach((e=>e.stop())),this.Et={},this.Tt.cancel(),this.closeLocalMediaStream(),this.kt=!1}createVideoCall(e){return a(this.kt,"Video bridge not active"),new m({bridge:this,isInbound:!1,isScreenSharing:!1,remotePartyId:e})}createScreenSharingCall(e){return a(this.kt,"Video bridge not activbe"),new m({bridge:this,isInboud:!1,isScreenSharing:!0,remotePartyId:e})}}class f{isShutdown=!1;userId=null;passwordHash=null;serviceUrl=null;bridge=null;constructor(e,t,i){this.userId=e,this.passwordHash=t,this.serviceUrl=i,this.isRunning=!1}noop(){}startBridge(e){(e=e||{}).onincomingcall=e.onincomingcall||this.noop,e.onbridgeactive=e.onbridgeactive||this.noop,e.onbridgeinactive=e.onbridgeinactive||this.noop,e.onbridgefailure=e.onbridgefailure||this.noop,this.bridge=new p({userId:this.userId,passwordHash:this.passwordHash,type:"normal",serviceUrl:this.serviceUrl}),console.log("Instantiated bridge "+this.userId),this.bridge.onincomingcall=t=>{console.log("Receiving call from "+t.getRemotePartyId()+" for "+this.userId),e.onincomingcall(t)},this.bridge.onbridgeactive=t=>{console.log("The bridge is active "+this.userId),e.onbridgeactive(t)},this.bridge.onbridgeinactive=t=>{console.log("The bridge is inactive "+this.userId),e.onbridgeinactive(t)},this.bridge.onbridgefailure=t=>{if(console.error("The bridge failed "+this.userId),!this.isShutdown)try{e.onbridgefailure(t)}catch(e){console.error("Failure occurred in bridge shutdown handler",e)}this.isShutdown=!0,this.shutdown()},this.bridge.start(),console.log("Started bridge "+this.userId),this.isShutdown=!1}hasLocalPermissionsEnabled(){return!!this.bridge&&this.bridge.hasLocalPermissionsEnabled()}shutdown(){this.isShutdown||(this.bridge.shutdown(),this.isShutdown=!0)}restartMediaStream(){this.isShutdown&&console.error("Bridge is shutdown.  Cannot restart media stream")}getLocalMediaStream(){return this.bridge.getLocalMediaStream()}enableMicrophone(e){return this.bridge.enableMicrophone(e)}enableCamera(e){return this.bridge.enableCamera(e)}makeScreenshareCall(e){return this.bridge.makeScreenshareCall(e)}setCallHandlers(e){return this.bridge.setCallHandlers(e)}}function v(e,i){let o=this;function a(e,t,i,n){t?(e.classList.add(i),e.classList.remove(n)):(e.classList.add(n),e.classList.remove(i))}this.waitingRoomTemplate=null,this.conferenceRoomTemplate=null,this.callerSettings=null,this.telehealthSessionData=null,this.videoBar=null,this.ROOM_TYPE_WAITING="waiting",this.ROOM_TYPE_CONFERENCE="conference",this.buttonSettings={microphoneEnabled:!0,cameraEnabled:!0},this.sessionUpdatePollingTime=5e3,this.room=null,this.waitingRoomModal=null,this.inSession=!1,this.isMinimized=!1,this.sessionUpdateInterval=null,this.__hasLocalPermisions=!1,this.__bridge=null,this.__localVideoElement=null,this.__slots=[],this.__localCaller=null,this.__remoteCaller=null,this.__remoteCallSlot=null,this.__isShutdown=!0,this.setupCallers=function(){this.__localCaller=new s("local-video","local-screenshare"),this.setupRemoteCaller()},this.setupRemoteCaller=function(){this.__remoteCaller=new s("remote-video-1","remote-screenshare-1"),this.__slots.push(this.__remoteCaller)},this.allocateSlot=function(e,t){if(!e.getUserData()){for(var i=0;i<this.__slots.length;i++)if(this.__slots[i].isAvailableForCall(e))return void this.__slots[i].attach(e,t);console.error("allocateSlot called but all slots are full")}},this.freeSlot=function(e){null===e||null!=!e.isAvailable()?(e.__call.stop(),e.detach(),e==o.__remoteCallSlot&&(o.__remoteCallSlot=null)):console.error("freeSlot called with null slot ",{slot:e})},this.restartMediaStream=function(){return o.__localVideoElement.srcObject&&o.__bridge.closeLocalMediaStream(),o.__bridge.getLocalMediaStream().then((e=>o.handleLocalMediaStreamStarted(e))).catch((e=>o.handleLocalMediaStreamFailed(e)))},this.handleLocalMediaStreamStarted=function(e){return o.__localVideoElement.srcObject=e,o.__localVideoElement.play(),o.__hasLocalPermisions=!0,o.toggleJoinButton(o.shouldEnableJoinButton()),o.togglePermissionBox(!1),o.__hasLocalPermisions},this.handleLocalMediaStreamFailed=function(e){return console.error(e),o.__hasLocalPermisions=!1,o.toggleJoinButton(o.shouldEnableJoinButton()),o.togglePermissionBox(!0),o.__hasLocalPermisions},this.startBridge=function(){o.__localVideoElement=document.getElementById("local-video"),o.__localVideoElement.muted=!0,o.__bridge=new f(o.callerSettings.callerUuid,o.callerSettings.apiKey,o.callerSettings.serviceUrl);let t={onincomingcall:o.handleIncomingCall.bind(o),onbridgeactive:e=>{o.restartMediaStream()},onbridgeinactive:e=>{o.__localVideoElement&&o.__localVideoElement.stop&&(o.__localVideoElement.stop(),o.__localVideoElement.srcObject=null)},onbridgefailure:t=>{o.__localVideoElement&&o.__localVideoElement.stop&&o.__localVideoElement.stop(),o.__localVideoElement.srcObject=null,alert(e.BRIDGE_FAILED)}};o.__bridge.startBridge(t),o.__isShutdown=!1},o.shutdown=function(){o.__isShutdown||(o.__bridge.shutdown(),o.__localVideoElement.srcObject=null,console.log("Shutting down "+o.callerSettings.callerUuid),o.__isShutdown=!0)},this.setCallHandlers=function(e){e.oncallstarted=e=>{o.handleCallStartedEvent(e)},e.onstreamupdated=(e,t)=>{console.log("onstreamupdated "+o.callerSettings.calleeUuid),o.allocateSlot(e,t)},e.oncallended=e=>{o.freeSlot(e.getUserData()),o.handleCallEndedEvent(e)}},this.makeCall=function(t){const i=this.__bridge.createVideoCall(t);o.setCallHandlers(i),i.oncallrejected=e=>{console.log(e),console.log("oncallrejected "+o.callerSettings.calleeUuid),o.handleCallEndedEvent(e)},i.start().catch((t=>{alert(e.CALL_CONNECT_FAILED),console.log("call exception "+o.callerSettings.calleeUuid),console.error(t),o.handleCallEndedEvent(i)}))},this.makeScreenshareCall=function(t){const i=o.__bridge.createScreenSharingCall(t);o.setCallHandlers(i),i.start().catch((t=>{alert(e.CALL_CONNECT_FAILED),console.log("call exception "+o.callerSettings.calleeUuid),console.error(t),o.handleCallEndedEvent(i)}))},this.enableMicrophone=function(e){o.__bridge.enableMicrophone(e)},this.enableCamera=function(e){o.__bridge.enableCamera(e)},this.hasLocalPermissionsEnabled=function(){return o.__hasLocalPermisions},this.canReceiveCall=function(e){return e.getRemotePartyId()===o.callerSettings.calleeUuid?Promise.resolve({call:e,canCall:!0}):Promise.resolve({call:e,canCall:!1})},this.getRemoteScriptLocation=function(){return i},this.getTelehealthLaunchData=function(e){var t=this.getRemoteScriptLocation()+"?action=get_telehealth_launch_data&eid="+encodeURIComponent(e.pc_eid);return window.top.restoreSession(),window.fetch(t,{redirect:"manual"})},this.setupProviderWaitingRoom=function(){let e=this.createModalWithContent(o.waitingRoomTemplate),t=document.getElementById("telehealth-container");o.initWaitingRoomEvents(t),o.waitingRoomModal=e,o.waitingRoomModal.show()},this.setupWaitingRoom=function(){o.setupProviderWaitingRoom()},this.handleIncomingCall=function(e){this.canReceiveCall(e).then((e=>{if(!e.canCall)return console.log("Call from "+e.call.getRemotePartyId()+" not authorized by server for "+o.callerSettings.callerUuid),void e.call.reject();o.__bridge.setCallHandlers(e.call),e.call.accept(),console.log("Call accepted from "+e.call.getRemotePartyId()+" for "+o.callerSettings.callerUuid),o.toggleRemoteVideo(!0)})).catch((t=>{e.reject()}))},this.init=function(t){t.pc_eid?(o.telehealthSessionData=t,o.getTelehealthLaunchData(t).then((function(e){if(!e.ok||200!=e.status)throw new Error("Failed to fetch data");return e.json()})).then((e=>{o.inSession=!0,o.callerSettings=e.callerSettings,o.waitingRoomTemplate=e.waitingRoom,o.conferenceRoomTemplate=e.conferenceRoom,o.setupWaitingRoom(),o.startBridge(),o.room=o.ROOM_TYPE_WAITING})).catch((function(t){console.error(t),o.__bridge||(alert(e.SESSION_LAUNCH_FAILED),o.destruct())}))):alert(e.SESSION_LAUNCH_FAILED)},this.destruct=function(){o.inSession=!1,o.waitingRoomTemplate=null,o.conferenceRoomTemplate=null,o.videoBar&&(o.videoBar.destruct(),o.videoBar=null),o.room==o.ROOM_TYPE_WAITING||(o.room,o.ROOM_TYPE_CONFERENCE),null!==o.sessionUpdateInterval&&(clearInterval(o.sessionUpdateInterval),o.sessionUpdateInterval=null);let e=document.getElementById("telehealth-container");if(o.__bridge&&o.__bridge.shutdown)try{o.__bridge.shutdown()}catch(e){console.error(e)}if(e&&e.parentNode&&e.parentNode.removeChild(e),o.isMinimized){let e=document.getElementById("minimized-telehealth-video");e&&e.parentNode&&e.parentNode.removeChild(e),o.isMinimized=!1}o.callerSettings=null,o.telehealthSessionData=null},this.initModalEvents=function(e){for(var t=document.getElementsByClassName("btn-telehealth-provider-close"),i=0;i<t.length;i++)t[i].addEventListener("click",o.handleCallHangup)},this.initWaitingRoomEvents=function(e){o.videoBar=new n(e,o.getWaitingRoomVideoBarSettings()),o.toggleJoinButton(o.shouldEnableJoinButton())},this.togglePermissionBox=function(e){let t=document.querySelector("#telehealth-container .permissions-box"),i=document.querySelector("#telehealth-container .permissions-box .restart-media-btn");t&&i?e?(i.addEventListener("click",o.recaptureLocalMedia),t.classList.remove("d-none")):(t.classList.add("d-none"),i.removeEventListener("click",o.recaptureLocalMedia)):console.error("Could not find permissions box dom nodes")},this.recaptureLocalMedia=function(){o.__bridge&&!o.__bridge.isShutdown&&o.__bridge.shutdown(),o.startBridge()},this.shouldEnableJoinButton=function(){return o.hasLocalPermissionsEnabled()},this.toggleJoinButton=function(e){let t=document.querySelectorAll(".btn-comlink-conference-join");if(t&&t.length)for(let i=0;i<t.length;i++)e?(t[i].addEventListener("click",o.startConferenceRoom),t[i].classList.remove("disabled"),t[i].disabled=!1):(t[i].removeEventListener("click",o.startConferenceRoom),t[i].classList.add("disabled"),t[i].disabled=!0)},this.sessionClose=function(){let e=this;e.isMinimized?e.destruct():(jQuery("#telehealth-container").on("hidden.bs.modal",(function(){jQuery("#telehealth-container").off("hidden.bs.modal"),e.destruct()})),e.waitingRoomModal.hide())},this.confirmSessionClose=function(){o.room==o.ROOM_TYPE_WAITING?o.sessionClose():new t(o.telehealthSessionData.pc_eid,i,(function(){o.sessionClose()})).show()},this.shutdownProviderWaitingRoom=function(){let e=document.getElementById("telehealth-container");if(o.__bridge&&o.__bridge.shutdown)try{o.__bridge.shutdown()}catch(e){console.error(e)}e&&e.parentNode&&e.parentNode.removeChild(e),o.callerSettings=null,o.telehealthSessionData=null},this.createModalWithContent=function(t){let i=window.document.createElement("div");i.innerHTML='<div class="modal fade" id="telehealth-container" tabindex="-1" aria-hidden="true">\n              <div class="modal-dialog mw-100 ml-2 mr-2">\n                <div class="modal-content">\n                  <div class="modal-header">\n                    <h5 class="modal-title">'+jsText(e.TELEHEALTH_MODAL_TITLE)+`</h5>\n                    <button type="button" class="close btn-telehealth-provider-close" aria-label="Close">\n                      <span aria-hidden="true">&times;</span>\n                    </button>\n                  </div>\n                  <div class="modal-body d-flex">\n                  ${t}\n                  </div>\n                </div>\n              </div>\n            </div>`,window.document.body.appendChild(i.firstElementChild);var n=document.getElementById("telehealth-container");return o.waitingRoomModal=new bootstrap.Modal(n,{keyboard:!1,focus:!0,backdrop:"static"}),o.initModalEvents(n),o.waitingRoomModal},this.startConferenceRoom=function(){o.startProviderConferenceRoom()},this.startProviderConferenceRoom=function(){let e=document.getElementById("telehealth-container"),t=document.getElementById("local-video");o.videoBar.destruct();let i=e.querySelector(".modal-body");do{i.removeChild(i.firstChild)}while(i.childNodes.length);i.innerHTML=o.conferenceRoomTemplate;let s=document.getElementById("local-video");s&&s.parentNode&&s.parentNode.replaceChild(t,s);let a=i.querySelector(".telehealth-button-bar");o.videoBar=new n(a,o.getFullConferenceVideoBarSettings()),o.inConferenceRoom=!0,o.room=o.ROOM_TYPE_CONFERENCE,this.sessionUpdateInterval=setInterval(o.updateConferenceRoomSession.bind(o),o.sessionUpdatePollingTime),o.updateConferenceRoomSession()},this.updateConferenceRoomSession=function(){let e=(o.callerSettings.appointment||{}).eid||{};window.top.restoreSession(),window.fetch(o.getRemoteScriptLocation()+"?action=conference_session_update&eid="+encodeURIComponent(e),{redirect:"manual"}).then((e=>{if(e.ok)return e.json();throw new Error("Failed to update session")})).catch((e=>console.error("Conference session update ",e)))},this.cancelUpdateConferenceRoomSession=function(){o.sessionUpdateInterval&&window.clearInterval(o.sessionUpdateInterval)},this.getDefaultVideoBarSettings=function(){var e=function(){};return{notes:!1,notesCallback:e,microphone:o.buttonSettings.microphoneEnabled,microphoneCallback:o.toggleMicrophone.bind(o),video:o.buttonSettings.cameraEnabled,videoCallback:o.toggleVideo.bind(o),expand:!1,expandCallback:e,hangup:!1,hangupCallback:e,screenshare:!1,screenshareCallback:o.toggleScreenSharing.bind(o)}},this.getWaitingRoomVideoBarSettings=function(){return o.getDefaultVideoBarSettings()},this.getMinimizedConferenceVideoBarSettings=function(){let e=o.getDefaultVideoBarSettings();return e.expandCallback=o.maximizeProviderConferenceCall.bind(o),e.hangupCallback=o.handleCallHangup.bind(o),e.expand=!0,e.notes=!1,e.hangup=!0,e.screenshare=!1,e},this.getFullConferenceVideoBarPatientSettings=function(){let e=o.getDefaultVideoBarSettings();return e.hangupCallback=o.handleCallHangup.bind(o),e.expand=!1,e.notes=!1,e.hangup=!0,e.screenshare=!0,e},this.getFullConferenceVideoBarSettings=function(){let e=o.getDefaultVideoBarSettings();return e.hangupCallback=o.handleCallHangup.bind(o),e.notesCallback=o.minimizeProviderConferenceCall.bind(o),e.expand=!1,e.notes=!0,e.hangup=!0,e.screenshare=!1,e},this.handleCallStartedEvent=function(e){o.toggleRemoteVideo(!0)},this.handleCallEndedEvent=function(e){o.toggleRemoteVideo(!1)},this.handleCallHangup=function(){o.isMinimized&&o.maximizeProviderConferenceCall({}),o.confirmSessionClose()},this.minimizeProviderConferenceCall=function(){var e=document.getElementById("telehealth-container"),t=document.getElementById("remote-video"),i=document.createElement("div");i.id="minimized-telehealth-video",i.className="col-lg-2 col-md-3 col-sm-4 col-6 drag-action",window.document.body.appendChild(i),i.appendChild(t);var s=e.querySelector(".telehealth-button-bar").cloneNode(!0);i.appendChild(s),o.videoBar.destruct(),o.videoBar=new n(s,o.getMinimizedConferenceVideoBarSettings()),o.waitingRoomModal.hide(),window.initDragResize&&window.initDragResize(),o.isMinimized=!0},this.maximizeProviderConferenceCall=function(e){var t=document.querySelector(".remote-video-container"),i=document.getElementById("remote-video");if(i&&t){var s=i.parentNode,a=s.querySelector(".telehealth-button-bar");if(a&&(o.videoBar.destruct(),a.parentNode.removeChild(a)),t){var l=t.querySelector(".telehealth-button-bar");l?o.videoBar=new n(l,o.getFullConferenceVideoBarSettings()):console.error("Failed to find #remote-video-container .telehealth-button-bar")}else console.error("Failed to find #remote-video-container");t.prepend(i),s&&s.parentNode&&s.parentNode.removeChild(s)}else console.error("Failed to find remote video or remote video container");o.waitingRoomModal?(o.waitingRoomModal.show(),o.isMinimized=!1):console.error("Failed to find waitingRoomModal")},this.toggleMicrophone=function(e){let t=e.target;t.classList.contains("fa")||(t=t.querySelector(".fa"));let i=!o.buttonSettings.microphoneEnabled;o.buttonSettings.microphoneEnabled=i,t.dataset.enabled=i,o.__bridge&&o.__bridge.enableMicrophone?o.__bridge.enableMicrophone(i):console.error("__bridge is not initalized and cannot toggle microphone"),a(t,i,"fa-microphone","fa-microphone-slash")},this.toggleVideo=function(e){let t=e.target;t.classList.contains("fa")||(t=t.querySelector(".fa"));let i=!o.buttonSettings.cameraEnabled;o.buttonSettings.cameraEnabled=i,t.dataset.enabled=i,o.__bridge&&o.__bridge.enableCamera?o.__bridge.enableCamera(i):console.error("app is not initalized and cannot toggle microphone"),a(t,i,"fa-video","fa-video-slash")},this.toggleRemoteVideo=function(e){var t=document.getElementById("telehealth-container"),i=t.querySelector(".waiting-container"),n=t.querySelector(".remote-video");e?(i.classList.add("d-none"),n.classList.remove("d-none")):(i.classList.remove("d-none"),n.classList.add("d-none"))},this.toggleScreenSharing=function(e){o.__bridge.makeScreenshareCall(o.callerSettings.calleeUuid)},this.toggleRemoteScreensharing=function(e){}}function b(e,t){let i=new v(e,t),n=i.destruct,o=null,s=!1;function a(){let e=i.telehealthSessionData.pc_eid;window.top.restoreSession(),window.fetch(t+"public/index-portal.php?action=patient_appointment_ready&eid="+encodeURIComponent(e),{redirect:"manual"}).then((e=>{if(e.ok)return e.json();throw new Error("Failed to get response back from server")})).then((e=>{e.session&&(s=!0===e.session.providerReady,e.session.calleeUuid&&(i.callerSettings.calleeUuid=e.session.calleeUuid),i.toggleJoinButton(i.shouldEnableJoinButton()))})).catch((e=>{let t=document.querySelector(".waiting-room-server-communication");t&&t.classList.remove("d-none"),console.error(e)}))}return i.getFullConferenceVideoBarSettings=i.getFullConferenceVideoBarPatientSettings,i.startConferenceRoom=function(){i.stopProviderReadyCheck(),i.startProviderConferenceRoom(),i.app.makeCall(i.callerSettings.calleeUuid)},i.handleIncomingCall=function(e){console.log("Received call ",e)},i.handleCallEndedEvent=function(t){alert(e.HOST_LEFT),i.replaceConferenceRoomWithWaitingRoom(),i.cancelUpdateConferenceRoomSession()},i.replaceConferenceRoomWithWaitingRoom=function(){i.telehealthSessionData,i.waitingRoomModal;var e=document.getElementById("telehealth-container"),t=e.querySelector(".modal-body"),n=document.getElementById("local-video");i.videoBar.destruct(),t.innerHTML=i.waitingRoomTemplate;var o=document.getElementById("local-video");o?(o.parentNode.replaceChild(n,o),s=!1,i.initWaitingRoomEvents(e),i.startProviderReadyCheck()):console.error("Failed to find child video to replace")},i.handleCallHangup=function(){(i.room==i.ROOM_TYPE_WAITING||confirm(e.CONFIRM_SESSION_CLOSE))&&i.sessionClose()},i.setWaitingRoomModal=function(e){i.waitingRoomModal=e},i.setupWaitingRoom=function(){i.setupProviderWaitingRoom(),i.startProviderReadyCheck()},i.destruct=function(){i.stopProviderReadyCheck(),window.dlgclose&&window.dlgclose(),n.bind(i)()},i.stopProviderReadyCheck=function(){o&&(clearInterval(o),o=null)},i.startProviderReadyCheck=function(){o=setInterval(a,2e3)},i.shouldEnableJoinButton=function(){return s&&i.hasLocalPermissionsEnabled()},i}!function(t,i,n,o){let s=!1,a=i.settings.modulePath||"/interface/modules/custom_modules/oe-module-comlink-telehealth/",l=null,r=i.translations||{CALL_CONNECT_FAILED:"Failed to connect the call.",SESSION_LAUNCH_FAILED:"There was an error in launching your telehealth session.  Please try again or contact support",APPOINTMENT_STATUS_UPDATE_FAILED:"There was an error in saving the telehealth appointment status.  Please contact support or update the appointment manually in the calendar",DUPLICATE_SESSION:"You are already in a conference session.  Please hangup the current call to start a new telehealth session",HOST_LEFT:"Host left the call",CONFIRM_SESSION_CLOSE:"Are you sure you want to close this session?",TELEHEALTH_MODAL_TITLE:"TeleHealth Session",TELEHEALTH_MODAL_CONFIRM_TITLE:"Confirm Session Close",UPDATE_APPOINTMENT_STATUS:"Update appointment status",STATUS_NO_SHOW:"No Show",STATUS_CANCELED:"Canceled",STATUS_CHECKED_OUT:"Checked Out",STATUS_SKIP_UPDATE:"Skip Update",CONFIRM:"Confirm",STATUS_NO_UPDATE:"No Change",STATUS_OTHER:"Other"};function c(e){return!0===e?a+"public/index-portal.php":a+"public/index.php"}i.telehealth={showPatientPortalDialog:function(e){let t={pc_eid:e};s=new b(r,c(!0)),s.init(t)},launchProviderVideoMessage:function(e){if(s){if(s.inSession)return void alert(r.DUPLICATE_SESSION);s.destruct(),s=null}s=new v(r,c(!1)),s.init(e)},launchRegistrationChecker:function(t){l=new e(c(t)),l.checkRegistration()}},t.comlink=i}(window,window.comlink||{},bootstrap,$,window.dlgopen)}();