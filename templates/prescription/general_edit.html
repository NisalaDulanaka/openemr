{**
 * Prescription edit
 *
 * @package   OpenEMR
 * @link      http://www.open-emr.org
 * @author    Brady Miller <brady.g.miller@gmail.com>
 * @copyright Copyright (c) 2017-2018 Brady Miller <brady.g.miller@gmail.com>
 * @copyright Copyright (c) 2019 Robert Down <robertdown@live.com>
 * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3
 *}
<!DOCTYPE html>
<html>
<head>
{headerTemplate assets='jquery-ui|jquery-ui-base|datetime-picker|select2'}
<script>
{literal}
    function my_process () {
      // Pass the variable
      opener.document.prescribe.drug.value = document.lookup.drug.value;
      // Close the window
      window.self.close();
    }
{/literal}
</script>
<!---Gen Look up-->
{literal}
<script>

 // This holds all the default drug attributes.
 // This was html escaped previously
{/literal}
 var drugopts = [{$DRUG_ATTRIBUTES}];
{literal}

// Helper to choose an option from its value.
function selchoose(sel, value) {
    var o = sel.options;
    for (i = 0; i < o.length; ++i) {
        o[i].selected = (o[i].value == value);
    }
}

 // Fill in default values when a drop-down drug is selected.
function drugselected(sel) {
    var f = document.forms[0];
    var i = f.drug_id.selectedIndex - 1;
    if (i >= 0) {
        var d = drugopts[i];
        $("#form").val(d[1]).trigger("change");
        $("#unit").val(d[4]).trigger("change");
        $("#route").val(d[5]).trigger("change");
        $("#interval").val(d[6]).trigger("change");
        $("#substitute").val(d[7]).trigger("change");
        $("#refills").val(d[9]).trigger("change");
        f.drug.value = d[0];
        f.dosage.value = d[2];
        f.size.value = d[3];
        f.rxnorm_drugcode.value = d[11];
        f.quantity.value = d[8];
        f.disp_quantity.value = d[8];
        f.per_refill.value = d[10];
    }
    return true;
}

 // Invoke the popup to dispense a drug.
 function dispense() {
  var f = document.forms[0];
  dlgopen('interface/drugs/dispense_drug.php' +
   {/literal}'?drug_id=' + {$prescription->get_drug_id()|js_url} +{literal}
   '&prescription=' + encodeURIComponent(f.id.value) +
   '&quantity=' + f.encodeURIComponent(disp_quantity.value) +
   '&fee=' + encodeURIComponent(f.disp_fee.value),
   '_blank', 400, 200);
 }

 function quantityChanged() {
  var f = document.forms[0];
  f.per_refill.value = f.quantity.value;
  if (f.disp_quantity) {
   f.disp_quantity.value = f.quantity.value;
  }
 }

</script>
{/literal}
</head>
<body id="prescription_edit" class="body_top">
<div class="container-fluid">
    <form name="prescribe" id="prescribe" class="form-horizontal" method="post" action="{$FORM_ACTION}">
        <div class="form-group">
            <label for="start_date" class="control-label col-sm-2">{xlt t="Starting Date"}</label>
            <div class="col-sm-2">
                <input type="text" class="form-control datepicker" name="start_date" id="start_date" value="{$prescription->start_date|oeFormatShortDate|attr}">
            </div>
            <div class="col-sm-8">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="active" value="1" {if $prescription->get_active() > 0}checked{/if}>
                        {xlt t="Currently Active"}
                    </label>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="drug" class="control-label col-sm-2">{xlt t="Drug"}</label>
            <div class="col-sm-7">
                <div class="input-group">
                    <input type="text" class="form-control" id="drug" name="drug" placeholder="{xla t='e.x.'} {xla t='Aspirin'}" value="{$prescription->drug|attr}">
                    <span class="input-group-btn">
                        <button class="btn btn-default btn-search" tabindex="-1" type="button" onclick="$('#hiddendiv').show();document.getElementById('hidden_content').innerHTML='&lt;iframe src=&quot;controller.php?prescription&amp;lookup&amp;drug=&quot; width=&quot;100%&quot;height=&quot;75&quot; scrolling=&quot;no&quot; frameborder=&quot;no&quot;&gt;&lt;/iframe&gt;'">Search</button>
                    </span>
                </div>
            </div>
        </div>
        <div class="form-group" style="display: none" id="hiddendiv">
          <div class="col-sm-12">
              <div class="" id="hidden_content"></div>
          </div>
        </div>
        {if $DRUG_ARRAY_VALUES}
            <div class="form-group">
                <div class="col-sm-6 col-sm-offset-2">
                    <select class="form-control" id="drug_id" name="drug_id">
                        <option></option>
                        {html_options values=$DRUG_ARRAY_VALUES|attr output=$DRUG_ARRAY_OUTPUT selected=$prescription->get_drug_id()}
                    </select>
                    <input type="hidden" name="rxnorm_drugcode" value="{$prescription->rxnorm_drugcode|attr}">
                </div>
            </div>
        {/if}

        {if $SIMPLIFIED_PRESCRIPTIONS && !$prescription->size}
            {assign var="dosageVisibility" value="hidden"}
        {else}
            {assign var="dosageVisibility" value=""}
        {/if}
        <div class="form-group {$dosageVisibility}">
            <label for="size" class="control-label col-sm-2">{xlt t="Dosage"}</label>
            <div class="col-sm-2">
                <input type="text" class="form-control" name="size" id="size" placeholder="{xla t='ex'}  {xla t='81'}" maxlength="10" value="{$prescription->size|attr}">
            </div>
            <div class="col-sm-2">
                <select class="form-control" name="unit" id="unit">
                    <option></option>
                    {html_options options=$prescription->unit_array|attr selected=$prescription->unit}
                </select>
            </div>
            <label for="quantity" class="control-label col-sm-1">{xlt t="Quantity"}</label>
            <div class="col-sm-2">
                <input type="text" name="quantity" id="quantity" class="form-control" placeholder="{xla t='e.x.'}  {xla t='30'}" maxlength="31" value="{$prescription->quantity|attr}" onchange="quantityChanged()">
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-2">
                {if $SIMPLIFIED_PRESCRIPTIONS && !$prescription->form && !$prescription->route && !$prescription->interval}
                    <input class="form-control" type="text" name="dosage" id="dosage" size="30" maxlength="100" placeholder="{xla t='ex'} 81" value="{$prescription->dosage|attr}">
                    <input type="hidden" name="form" id="form" value="0">
                    <input type="hidden" name="route" id="route" value="0">
                    <input type="hidden" name="interval" id="interval" value="0">
                {else}
                    <input class="form-control" type="text" placeholder="{xla t='ex'} 1" name="dosage" id="dosage" size="2" maxlength="10" value="{$prescription->dosage|attr}">
                {/if}
            </div>
            <div class="col-sm-2">
                <select class="form-control" name="form" id="form">
                    <option></option>
                    {html_options options=$prescription->form_array|attr selected=$prescription->form}
                </select>
            </div>
            <div class="col-sm-3">
                <select class="form-control" name="route" id="route">
                    <option></option>
                    {html_options options=$prescription->route_array|attr selected=$prescription->route}
                </select>
            </div>
            <div class="col-sm-2">
                <select class="form-control" name="interval" id="interval">
                    <option></option>
                    {html_options options=$prescription->interval_array|attr selected=$prescription->interval}</select>
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-6">
                <div class="form-group">
                    <label for="per_refill" class="control-label col-sm-4">{xlt t="Refills"}</label>
                    <div class="col-sm-6">
                        {html_options name="refills" class="form-control" options=$prescription->refills_array|attr selected=$prescription->refills}
                    </div>
                </div>
                <div class="form-group">
                    {if $SIMPLIFIED_PRESCRIPTIONS}
                        <input type="hidden" id="per_refill" name="per_refill" value="{$prescription->per_refill|attr}">
                    {else}
                        <label for="per_refill" class="control-label col-sm-4">{xlt t="# of tablets"}</label>
                        <div class="col-sm-6">
                            <input class="form-control" type="text" id="per_refill" name="per_refill" size="2" maxlength="10" value="{$prescription->per_refill|attr}">
                        </div>
                    {/if}
                </div>
                {if !$WEIGHT_LOSS_CLINIC}
                    <div class="form-group">
                        <label for="medication" class="control-label col-sm-4">{xlt t="Add to Rx List"}</label>
                        <div class="col-sm-3">
                            {html_options name="medication" id="medication" class="form-control" options=$prescription->medication_array|attr selected=$prescription->medication}
                        </div>
                    </div>
                {/if}
                <div class="form-group">
                    <label for="substitute" class="control-label col-sm-4">{xlt t="Substitution"}</label>
                    <div class="col-sm-5">
                        {html_options class="form-control" id="substitute" name="substitute" options=$prescription->substitute_array|attr selected=$prescription->substitute}
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-8 col-sm-offset-4">
                        <select class="form-control" id="provider_id" name="provider_id">
                            <option></option>
                            {html_options options=$prescription->provider->utility_provider_array()|attr selected=$prescription->provider->get_id()}
                        </select>
                        <input type="hidden" name="patient_id" value="{$prescription->patient->id|attr}">
                    </div>
                </div>
                {if $DRUG_ARRAY_VALUES}
                    <div class="form-group">
                        {if $prescription->get_refills() <= $prescription->get_dispensation_count()}
                            <div class="col-sm-offset-4 col-sm-4">
                                <div class="input-group">
                                    <input class="input-sm form-control" type="text" name="disp_quantity" size="2" placeholder="{xla t='ex'} 1" maxlength="10" value="{$DISP_QUANTITY|attr}" />
                                    <span class="input-group-addon">{xlt t="units"}</span>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <span class="input-group-addon">{$GBL_CURRENCY_SYMBOL|text}</span>
                                    <input class="input-sm form-control" type="text" name="disp_fee" placeholder="10.99" size="5" maxlength="10" value="{$DISP_FEE|attr}" />
                                </div>
                            </div>
                        {else}
                            <div class="col-sm-offset-2 col-sm-5">
                                <p><small class="alert alert-warning">
                                    {xlt t='Prescription has reached its limit of'} <strong>{$prescription->get_refills()|text} {xlt t='refills'}</strong>.
                                </small></p>
                            </div>
                        {/if}
                    </div>
                {/if}
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <div class="col-sm-12">
                        <textarea class="form-control" name="note" rows="3" placeholder="{xla t='Notes'}">{$prescription->note|text}</textarea>
                    </div>
                    <div class="col-sm-12">
                        {if $GLOBALS.enable_amc_prompting}
                            {if $amcCollectReturn}{assign var="amcCheckedValue" value="checked"}{else}{assign var="amcCheckedValue" value=""}{/if}
                            {amcCollect amc_id='e_prescribe_amc' patient_id=$prescription->patient->id object_category='prescriptions' object_id=$prescription->id}
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" id="escribe_flag" name="escribe_flag" {$amcCheckedValue}>
                                    {xlt t='E-Prescription?'}
                                </label>
                            </div>
                            {amcCollect amc_id='e_prescribe_chk_formulary_amc' patient_id=$prescription->patient->id object_category='prescriptions' object_id=$prescription->id}
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" id="checked_formulary_flag" name="checked_formulary_flag" {$amcCheckedValue}>
                                    {xlt t='Checked Drug Formulary?'}
                                </label>
                            </div>
                            {amcCollect amc_id='e_prescribe_cont_subst_amc' patient_id=$prescription->patient->id object_category='prescriptions' object_id=$prescription->id}
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" id="controlled_substance_flag" name="controlled_substance_flag" {$amcCheckedValue}>
                                    {xlt t='Controlled Substance?'}
                                </label>
                            </div>
                        {/if}
                    </div>
                </div>
            </div>
        </div> <!-- End .form-group -->

        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <a href="#" onclick="submitfun();" class="btn btn-default btn-sm btn-save">{xlt t="Save Prescription"}</a>
                {if $DRUG_ARRAY_VALUES}
                    <button type="submit" name="disp_button"class='btn btn-sm btn-default btn-transmit'>{xla t='Save and Dispense'}</button>
                {/if}
                <a href="controller.php?prescription&list&id={$prescription->patient->id|attr_url}" class="btn btn-secondary btn-sm btn-cancel">{xlt t="Cancel"}</a>
            </div>
        </div>
        <input type="hidden" name="id" value="{$prescription->id|attr}" />
        <input type="hidden" name="process" value="{$PROCESS|attr}" />
        <script>
            {$ENDING_JAVASCRIPT}
        </script>
    </form>
</div> <!-- End .container-fluid -->

{literal}
<script>
function submitfun() {
    top.restoreSession();
    if (CheckForErrors(this)) {
        document.forms["prescribe"].submit();
    } else {
        return false;
    }
}

function iframetopardiv(name){
    document.getElementById('drug').value=name;
    $("#hiddendiv").html("&nbsp;").hide();
}

function cancelParlookup () {
    $('#hiddendiv').hide().html("&nbsp;");
}

$().ready(function() {
    $("#save, #back").on("click",function(){
        $("#clearButton",window.parent.document).css("display", "none");
        $("#backButton",window.parent.document).css("display", "none");
        $("#addButton",window.parent.document).css("display", "");
    });

    {/literal}
    {if $GLOBALS.weno_rx_enable}
        {literal}
        $('#drug').autocomplete({
            {/literal}
            source: 'library/ajax/drug_autocomplete/search.php?csrf_token_form=' + {$CSRF_TOKEN_FORM|js_url},
            minLength: 3
            {literal}
        });
        {/literal}
    {else}
        {literal}
        $('#drug').autocomplete({
            {/literal}
            source: 'library/ajax/prescription_drugname_lookup.php?csrf_token_form=' + {$CSRF_TOKEN_FORM|js_url},
            minLength: 1
            {literal}
        });
        {/literal}
    {/if}
    {literal}

    // Set the select2 boxes to open on focus.
    // on first focus (bubbles up to document), open the menu
    $(document).on('focus', '.select2-selection.select2-selection--single', function (e) {
        $(this).closest(".select2-container").siblings('select:enabled').select2('open');
    });

    // steal focus during close - only capture once and stop propogation
    $('select.select2').on('select2:closing', function (e) {
        $(e.target).data("select2").$selection.one('focus focusin', function (e) {
            // e.stopPropagation();
        });
    });

    $("#drug_id").on("change", function(e) {
        drugselected();
    });

    $("#drug").focus();
    $("#prescribe").submit(function() { return CheckForErrors(this) });

    {/literal}{datetimepickerSupport input='format'}{literal}

    $("#provider_id").select2({placeholder: "{/literal}{xlt t='Select Provider'}{literal}"});
    $("#unit").select2({placeholder: "{/literal}{xlt t='e.x. mg'}{literal}"});
    $("#form").select2({placeholder: "{/literal}{xlt t='e.x. tablet'}{literal}"});
    $("#route").select2({placeholder: "{/literal}{xlt t='e.x. PO'}{literal}"});
    $("#interval").select2({placeholder: "{/literal}{xlt t='e.x. daily'}{literal}"});
    $("#drug_id").select2({placeholder: "{/literal}{xlt t='or select from inventory'}{literal}"});
});

// check the form for required fields before submitting
var CheckForErrors = function(eObj) {
    // REQUIRED FIELDS
    if (CheckRequired('drug') == false) { return false; }
    if (CheckRequired('quantity') == false) { return false; }
    //if (CheckRequired('unit') == false) { return false; }
    //if (CheckRequired('size') == false) { return false; }
    if (CheckRequired('dosage') == false) { return false; }
    //if (CheckRequired('form') == false) { return false; }
    //if (CheckRequired('route') == false) { return false; }
    //if (CheckRequired('interval') == false) { return false; }

    return top.restoreSession();
};

function CheckRequired(objID) {
    // for text boxes
    if ($('#'+objID).is('input')) {
        if ($('#'+objID).val() == "") {
            alert({/literal}{xlj t='Missing a required field and will be highlighted'}{literal});
            $('#'+objID).css('background-color', '#f2dede');
            return false;
        }
    }
    // for select boxes
    if ($('#'+objID).is('select')) {
        if ($('#'+objID).val() == "0") {
            alert({/literal}{xlj t='Missing a required field'}{literal});
            $('#'+objID).css('background-color', '#f2dede');
            return false;
        }
    }

    return true;
}
</script>
{/literal}
</html>
